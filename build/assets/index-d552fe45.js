import{r as o,_ as V,ak as Te,al as De,V as b,aj as U,an as ge,bb as Me,bB as Re,aq as Ae,ar as Le,as as Ge,at as Ue,av as Oe,aw as Fe,j as d,ay as Be,f as W,h as I,F as X,bk as he,bp as $e,bo as He,bn as Ve,bm as We,bl as qe,bC as Y,B as J,x as Ye,ag as Xe,i as me,by as Ze,bz as Ke,bA as Je,k as Qe,l as et,aJ as tt,a4 as nt}from"./index-b17e6e7f.js";import{e as ot,m as re,b as E,u as xe,T as ye,L as st,C as rt,g as it}from"./constant-163649d8.js";import{u as R,p as at,g as ct,C as lt,H as Z,a as ut,b as be,c as dt,E as ft,P as pt,A as gt,d as ht,L as mt,e as xt,f as yt,V as bt,B as St,R as ae,O as wt,h as Ct}from"./EditIcon-b0bae617.js";import{k as Se,C as Pt}from"./react-toastify.esm-ac6bd257.js";import{u as A,a as S,f as vt}from"./index-e5e383e2.js";import{D as we,P as _t}from"./PlusIcon-179f716a.js";import{c as jt}from"./index.esm-de2ad175.js";import"./index-62fced0f.js";const ce=new ge,Q=new Me,le=new Re,ee=new b;class kt extends Te{constructor(){super(),this.size=0,this.color=new De("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var t;return(t=this.instance.current)==null?void 0:t.geometry}raycast(t,a){var s,i;const r=this.instance.current;if(!r||!r.geometry)return;const l=r.userData.instances.indexOf(this.instanceKey);if(l===-1||l>r.geometry.drawRange.count)return;const n=(s=(i=t.params.Points)==null?void 0:i.threshold)!==null&&s!==void 0?s:1;if(le.set(this.getWorldPosition(ee),n),t.ray.intersectsSphere(le)===!1)return;ce.copy(r.matrixWorld).invert(),Q.copy(t.ray).applyMatrix4(ce);const c=n/((this.scale.x+this.scale.y+this.scale.z)/3),h=c*c,f=Q.distanceSqToPoint(ee);if(f<h){const u=new b;Q.closestPointToPoint(ee,u),u.applyMatrix4(this.matrixWorld);const g=t.ray.origin.distanceTo(u);if(g<t.near||g>t.far)return;a.push({distance:g,distanceToRay:Math.sqrt(f),point:u,index:l,face:null,object:this})}}}let L,F;const Ce=o.createContext(null),ue=new ge,de=new b,Nt=o.forwardRef(({children:e,range:t,limit:a=1e3,...s},i)=>{const r=o.useRef(null),[l,n]=o.useState([]),[[c,h,f]]=o.useState(()=>[new Float32Array(a*3),Float32Array.from({length:a*3},()=>1),Float32Array.from({length:a},()=>1)]);o.useEffect(()=>{r.current.geometry.attributes.position.needsUpdate=!0}),E(()=>{for(r.current.updateMatrix(),r.current.updateMatrixWorld(),ue.copy(r.current.matrixWorld).invert(),r.current.geometry.drawRange.count=Math.min(a,t!==void 0?t:a,l.length),L=0;L<l.length;L++)F=l[L].current,F.getWorldPosition(de).applyMatrix4(ue),de.toArray(c,L*3),r.current.geometry.attributes.position.needsUpdate=!0,F.matrixWorldNeedsUpdate=!0,F.color.toArray(h,L*3),r.current.geometry.attributes.color.needsUpdate=!0,f.set([F.size],L),r.current.geometry.attributes.size.needsUpdate=!0});const u=o.useMemo(()=>({getParent:()=>r,subscribe:g=>(n(y=>[...y,g]),()=>n(y=>y.filter(C=>C.current!==g.current)))}),[]);return o.createElement("points",V({userData:{instances:l},matrixAutoUpdate:!1,ref:re([i,r]),raycast:()=>null},s),o.createElement("bufferGeometry",null,o.createElement("bufferAttribute",{attach:"attributes-position",count:c.length/3,array:c,itemSize:3,usage:U}),o.createElement("bufferAttribute",{attach:"attributes-color",count:h.length/3,array:h,itemSize:3,usage:U}),o.createElement("bufferAttribute",{attach:"attributes-size",count:f.length,array:f,itemSize:1,usage:U})),o.createElement(Ce.Provider,{value:u},e))}),Et=o.forwardRef(({children:e,...t},a)=>{o.useMemo(()=>ot({PositionPoint:kt}),[]);const s=o.useRef(),{subscribe:i,getParent:r}=o.useContext(Ce);return o.useLayoutEffect(()=>i(s),[]),o.createElement("positionPoint",V({instance:r(),instanceKey:s,ref:re([a,s])},t),e)}),zt=o.forwardRef(({children:e,positions:t,colors:a,sizes:s,stride:i=3,...r},l)=>{const n=o.useRef(null);return E(()=>{const c=n.current.geometry.attributes;c.position.needsUpdate=!0,a&&(c.color.needsUpdate=!0),s&&(c.size.needsUpdate=!0)}),o.createElement("points",V({ref:re([l,n])},r),o.createElement("bufferGeometry",null,o.createElement("bufferAttribute",{attach:"attributes-position",count:t.length/i,array:t,itemSize:i,usage:U}),a&&o.createElement("bufferAttribute",{attach:"attributes-color",count:a.length/i,array:a,itemSize:3,usage:U}),s&&o.createElement("bufferAttribute",{attach:"attributes-size",count:s.length/i,array:s,itemSize:1,usage:U})),e)}),It=o.forwardRef((e,t)=>e.positions instanceof Float32Array?o.createElement(zt,V({},e,{ref:t})):o.createElement(Nt,V({},e,{ref:t}))),Tt=(e,t,a,s,i)=>{const r=new Le,l=1e-5;r.absarc(l,l,l,-Math.PI/2,-Math.PI,!0),r.absarc(l,t-s*2,l,Math.PI,Math.PI/2,!0),r.absarc(e-s*2,t-s*2,l,Math.PI/2,0,!0),r.absarc(e-s*2,l,l,0,-Math.PI/2,!0);const n=new Ge(r,{depth:a-s*2,bevelEnabled:!0,bevelSegments:i,steps:2,bevelSize:s,bevelThickness:s,curveSegments:i});n.center();const c=[],h=n.getAttribute("normal"),f=n.getAttribute("position");for(let u=0;u<f.count;u+=1){const g=new b(h.getX(u),h.getY(u),h.getZ(u)),y=new b(f.getX(u),f.getY(u),f.getZ(u));let C=0,v=0;Math.abs(g.y)>.9?(C=y.x/e+.5,v=1-(y.z/a+.5)):Math.abs(g.x)>.9?(C=-y.z/a+.5,v=1-(-y.y/t+.5)):Math.abs(g.z)>.9&&(C=y.x/e+.5,v=1-(-y.y/t+.5)),c.push(C,v)}return n.setAttribute("uv",new Ue(c,2)),n};Tt(10,10,10,2,10);new Ae(10,10,10);const Dt=500,Mt=800,Rt=new b(0,0,0),At=16777215;let B=null;const Lt=500,ie=(e,t)=>{if(B)return null;B=setTimeout(()=>{B&&(clearTimeout(B),B=null)},Lt);const a=[];return e.forEach(i=>{const r=t.position.distanceTo(Rt.set(i.x,i.y,i.z));r<Mt&&a.push({id:i.ref_id||"",distance:r})}),a.sort((i,r)=>i.distance-r.distance).slice(0,Dt).map(i=>i.id)},D=new b(0,0,0),fe=100,Gt=600,Ut=2e3,te={x:172.7392402058252,y:-239.04675366094037,z:-2e3};let G,$;const Ot=4e3,Ft=2e3,Bt=e=>{const t=A(),a=S(m=>m.cameraFocusTrigger),s=R(m=>m.isUserDragging),i=R(m=>m.isUserScrolling),r=R(m=>m.setUserMovedCamera),l=S(m=>m.setNearbyNodeIds),n=S(m=>m.showSelectionGraph),c=S(m=>m.data),h=S(m=>m.graphStyle),{camera:f}=xe(),[u,g]=o.useState(!1),[y,C]=o.useState(!1),[v,k]=o.useState(fe),p=o.useMemo(()=>{if(n)return new b(0,0,0);const m=c==null?void 0:c.nodes.find(z=>z.ref_id===(t==null?void 0:t.ref_id));let _=new b(2e3,2e3,3e3);if(m&&c){const z=[],O=new b(m.x,m.y,m.z);let K=new b(0,0,0);z.map(q=>(K=K.add(new b(q.x,q.y,q.z).normalize()),q));const ze=m.edge_count?1-1/(m.edge_count+10):1,Ie=O.sub(K).multiplyScalar(.8*ze);_=O.add(Ie)}return _},[n,t,c]),P=o.useMemo(()=>{if(n)return new b(0,0,0);const m=c==null?void 0:c.nodes.find(_=>_.ref_id===(t==null?void 0:t.ref_id));return new b((m==null?void 0:m.x)||0,(m==null?void 0:m.y)||0,(m==null?void 0:m.z)||0)},[n,t,c]);o.useEffect(()=>{var m;n&&((m=e.current)==null||m.setLookAt(te.x,te.y,te.z,0,0,0,!1)),j()},[n]),o.useEffect(()=>{n?k(Ut):(t==null?void 0:t.node_type)==="topic"?k(Gt):k(fe)},[t,k,n]),o.useEffect(()=>{x()},[a]),o.useEffect(()=>{(s||i)&&(g(!0),C(!0))},[s,i,g,C]),o.useEffect(()=>{if(t)if(!n&&h==="earth"&&(e!=null&&e.current)){const m=e.current.camera.position.distanceTo(new b),_=Oe(P,-m/2);e.current.setLookAt(_.x,_.y,_.z,0,0,0,!0)}else G&&clearTimeout(G),G=setTimeout(()=>{C(!0),clearTimeout(G)},Ft),j();return()=>{G&&clearTimeout(G),$&&clearTimeout($)}},[t]),E(m=>{e.current&&(u||w(p,m.camera),y||M(P,m.camera))});const j=()=>{if(t){const m=f.position.distanceTo(p);at(m)}x()},x=()=>{g(!1),C(!1),r(!1),$&&clearTimeout($),$=setTimeout(()=>{g(!0),C(!0)},Ot)},w=(m,_)=>{if(_.position.distanceTo(m)<v)g(!0);else{_.position.lerp(m,.5);const O=ie((c==null?void 0:c.nodes)||[],f);O&&l(O)}},M=(m,_)=>{var z;(z=e==null?void 0:e.current)==null||z.setLookAt(_.position.x,_.position.y,_.position.z,m.x,m.y,m.z,!0)};return null},$t=1;let T=null;const Ht=(e,{enabled:t})=>{const a=A();Bt(e);const s=R(f=>f.isUserDragging),i=S(f=>f.disableCameraRotation),r=S(f=>f.data),l=S(f=>f.graphStyle),n=S(f=>f.graphRadius),c=S(f=>f.setNearbyNodeIds);o.useEffect(()=>{t||(T==null||T.kill(),T=null)},[t]);const h=o.useCallback(()=>{T==null||T.kill();const f={value:-244},u=ct.to(f,{duration:5,keyframes:{"0%":{value:10},"100%":{delay:2,ease:"Power4.easeIn",value:-200}},onComplete:()=>{T=null},onInterrupt(){u.kill()},onUpdate:()=>{var y;const{value:g}=f;if(e.current){const C=ie((r==null?void 0:r.nodes)||[],e.current.camera);C&&c(C),(y=e.current)==null||y.dolly(g,!1)}}});u.play(),T=u},[]);return o.useEffect(()=>{e.current&&n&&(l==="sphere"?(e.current.maxDistance=8e3,e.current.minDistance=200,e.current.setTarget(0,0,500,!0)):(e.current.maxDistance=e.current.getDistanceToFitSphere(n+200),e.current.minDistance=100))},[n,l,e]),o.useEffect(()=>{h()},[h,l]),o.useEffect(()=>{!a&&e.current&&e.current.setLookAt(D.x,D.y,D.z,0,0,0,!0)},[a]),E((f,u)=>{e.current&&(!i&&!s&&(e.current.azimuthAngle+=$t*u*Fe.DEG2RAD),e.current.update(u))}),null},Vt=({disableAnimations:e})=>{const t=o.useRef(null),a=S(g=>g.graphStyle),s=S(g=>g.data),i=S(g=>g.setNearbyNodeIds),r=S(g=>g.setDisableCameraRotation),[l]=o.useState(.8),{camera:n}=xe(),[c,h,f,u]=R(g=>[g.isUserDragging,g.setIsUserDragging,g.isUserScrolling,g.isUserScrollingOnHtmlPanel]);return Ht(t,{enabled:!e&&!f&&!c}),o.useEffect(()=>{t.current&&t.current.setLookAt(D.x,D.y,D.z,0,0,0,!0)},[a]),o.useEffect(()=>{if(!c){const g=ie((s==null?void 0:s.nodes)||[],n);g&&i(g)}},[n,n.position,n.position.x,n.position.y,n.position.z,s==null?void 0:s.nodes,i,c]),o.useEffect(()=>{c&&r(!0)},[c,r]),d.jsx(lt,{ref:t,boundaryEnclosesCamera:!0,enabled:!u,makeDefault:!0,maxDistance:12e3,minDistance:100,onEnd:()=>h(!1),onStart:()=>h(!0),smoothTime:l})},Wt=["#ffffff","#ffffcc","#ccffcc","#ffccff","#ccccff","#ffd699","#c2f0c2","#ff6666","#99ccff","#ffb3b3"],qt=new b,Yt=({position:e,userData:t})=>{const a=o.useRef(null),[s,i]=S(n=>[n.selectedNode,n.nodeTypes]),r=S(n=>n.showSelectionGraph);return E(()=>{if(r&&a.current){const n=qt.set((t==null?void 0:t.x)||0,(t==null?void 0:t.y)||0,(t==null?void 0:t.z)||0);a.current.position.copy(n)}}),o.useEffect(()=>function(){a.current&&a.current.clear()},[a]),(s==null?void 0:s.ref_id)===(t==null?void 0:t.ref_id)?null:d.jsx("group",{ref:a,position:e,children:d.jsx(Z,{center:!0,sprite:!0,zIndexRange:[0,0],children:d.jsx(Xt,{bgColor:Wt[Math.max(i.indexOf(t.node_type),0)],children:t.node_type})})})},Pe=o.memo(()=>{const e=S(r=>r.data),t=S(r=>r.showSelectionGraph),a=S(r=>r.selectionGraphData),s=S(r=>r.selectedNodeRelativeIds),i=o.useMemo(()=>(t?a.nodes:(e==null?void 0:e.nodes)||[]).filter(c=>s.includes((c==null?void 0:c.ref_id)||"")).slice(0,Be).map(c=>{const h=new b((c==null?void 0:c.x)||0,(c==null?void 0:c.y)||0,(c==null?void 0:c.z)||0),f=[];return d.jsx(Yt,{position:h,relativeIds:f,userData:c},`node-badge-${c.ref_id}`)}),[s,e==null?void 0:e.nodes,t,a]);return d.jsx(o.Fragment,{children:i.length?i:null},"node-badges")});Pe.displayName="RelevanceBadges";const Xt=W.div`
  position: absolute;
  left: 50%;
  top: 20%;
  transform: translateX(-50%) translateY(200%);
  padding: 0 4px;
  height: 14px;
  background: ${e=>e.bgColor};
  color: ${I.BG1};
  font-size: 8px;
  font-style: normal;
  font-weight: 800;
  line-height: 14px;
`,Zt=({position:e,title:t,onRemove:a})=>{const s=o.useRef(null);return o.useEffect(()=>function(){s.current&&s.current.clear()},[s]),d.jsx("group",{ref:s,position:e,children:d.jsx(Z,{center:!0,sprite:!0,children:d.jsxs(Kt,{direction:"row",justify:"center",onClick:i=>{i.stopPropagation()},onPointerOut:i=>{i.stopPropagation()},onPointerOver:i=>{i.stopPropagation()},children:[d.jsx("span",{children:t}),d.jsx(X,{className:"icon",onClick:a,children:d.jsx(we,{})})]})})})},Kt=W(X)`
  text-align: center;

  outline-offset: 0px;
  background: rgba(0, 0, 0, 0.75);
  color: #eee;
  cursor: pointer;
  transition: font-size 0.4s, outline 0.4s;
  align-items: center;
  justify-content: center;
  font-family: Barlow;
  font-size: 16px;
  font-style: normal;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);

  &:hover {
    outline-offset: 4px;
    span {
      opacity: 0.1;
    }

    .icon {
      display: flex;
    }
  }

  .icon {
    position: absolute;
    width: 24px;
    height: 24px;
    /* bottom: 100%; */
    display: none;
    color: #000;
    border-radius: 40px;
    justify-content: center;
    align-items: center;
    background: #ffffff;
    color: #000;
    border-radius: 100%;
    font-size: 16px;
    cursor: pointer;
    transition: opacity 0.4s;
    box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
  }

  .badge-wrapper {
    position: absolute;
    top: -7px;
    left: -14px;
  }
`,Jt=(e,t)=>{const a=e.reduce((i,r,l)=>{if(l<e.length-1){const n=e[l+1],c=new b().subVectors(n,r).length();return i+c}return i},0);let s=0;for(let i=0;i<e.length-1;i+=1){const r=e[i],l=e[i+1],n=new b().subVectors(l,r).length();if(t<=(s+n)/a){const c=(t*a-s)/n;return new b().lerpVectors(r,l,c)}s+=n}return e[e.length-1]},Qt=({link:e,title:t,onRemove:a})=>{const s=o.useRef(null),i=o.useRef(null),r=A(),[l,n]=o.useState(new b(0,0,0)),[c,h]=o.useState(new b(0,0,0)),[f,u]=o.useState("#ff13c9"),[g]=S(x=>[x.selectionGraphData]),[y,C]=o.useState(0);E(()=>{C(x=>(x+.01)%1)}),o.useEffect(()=>{var x,w,M,m,_,z;n(new b(((x=e.sourcePosition)==null?void 0:x.x)||0,((w=e.sourcePosition)==null?void 0:w.y)||0,((M=e.sourcePosition)==null?void 0:M.z)||0)),h(new b(((m=e.targetPosition)==null?void 0:m.x)||0,((_=e.targetPosition)==null?void 0:_.y)||0,((z=e.targetPosition)==null?void 0:z.z)||0)),u("#ff13c9")},[r,e]);const v=new b().addVectors(l,c).multiplyScalar(.5);E(()=>{if(s.current){const x=g.nodes.find(M=>M.ref_id===e.source),w=g.nodes.find(M=>M.ref_id===e.target);s.current.start.set((x==null?void 0:x.x)||0,(x==null?void 0:x.y)||0,(x==null?void 0:x.z)||0),s.current.end.set((w==null?void 0:w.x)||0,(w==null?void 0:w.y)||0,(w==null?void 0:w.z)||0),n(new b((x==null?void 0:x.x)||0,(x==null?void 0:x.y)||0,(x==null?void 0:x.z)||0)),h(new b((w==null?void 0:w.x)||0,(w==null?void 0:w.y)||0,(w==null?void 0:w.z)||0))}});const k=new b(0,0,0),p=![e.target,e.source].includes((r==null?void 0:r.ref_id)||""),P=new he(l,k,c),j=p?P.getPoints(2):[l,c];return d.jsxs(d.Fragment,{children:[d.jsx(ut,{ref:s,color:"transparent",end:c,start:l}),d.jsxs(It,{limit:1,range:1,children:[d.jsx("pointsMaterial",{vertexColors:!0}),d.jsx(Et,{ref:i,color:f,position:Jt(j,y),size:20})]}),d.jsx(Zt,{onRemove:a,position:v,title:t})]})},en={font:"/fonts/Inter-Bold.woff",characters:"abcdefghijklmnopqrstuvwxyz0123456789!",fontSize:8,letterSpacing:-.05,lineHeight:1,"material-toneMapped":!1},ve=o.memo(({node:e})=>{const t=o.useRef(null),a=A(),i=S(h=>h.selectedNodeRelativeIds).includes((e==null?void 0:e.ref_id)||""),r=!!a&&(a==null?void 0:a.ref_id)===e.ref_id,l=S(h=>h.showSelectionGraph);E(({camera:h})=>{t!=null&&t.current&&(t.current.quaternion.copy(h.quaternion),l&&t.current.position.set(e.x,e.y,e.z))});const n=o.useMemo(()=>((e.edge_count||1)*4,(e.edge_count||1)*4),[e.edge_count,r,i,l]),c=o.useMemo(()=>1,[r,a,i]);return d.jsx(ye,{ref:t,anchorX:"center",anchorY:"middle",color:I.white,fillOpacity:c,position:[e.x,e.y,e.z],scale:Math.min(n,10),userData:e,visible:!0,...en,children:e.name})});ve.displayName="SelectionNode";const pe=$e().stop(),N={numDimensions:3,velocityDecay:.9,forceChargeStrength:-20,forceChargeMinDistance:150,forceChargeMaxDistance:8e3,forceLinkStrength:.04,forceCenterStrength:.85,disableCollide:!1,disableCenter:!1,disableLink:!1,disableCharge:!1,forceCollideRadiusMethod:e=>((e.edge_count||1)+20)*6+200,forceLinkDistanceMethod:()=>150},tn=(e,t,{numDimensions:a=N.numDimensions,velocityDecay:s=N.velocityDecay,forceChargeStrength:i=N.forceChargeStrength,forceChargeMinDistance:r=N.forceChargeMinDistance,forceChargeMaxDistance:l=N.forceChargeMaxDistance,forceLinkStrength:n=N.forceLinkStrength,forceCenterStrength:c=N.forceCenterStrength,forceLinkDistanceMethod:h=N.forceLinkDistanceMethod,forceCollideRadiusMethod:f=N.forceCollideRadiusMethod,disableCollide:u=N.disableCollide,disableCenter:g=N.disableCenter,disableLink:y=N.disableLink,disableCharge:C=N.disableCharge})=>(pe.alpha(1).stop().numDimensions(a).velocityDecay(s).force("collide",u?null:He().radius(f).iterations(1)).force("center",g?null:Ve().strength(c)).force("charge",C?null:We().strength(i).distanceMin(r).distanceMax(l)).nodes(e).force("link",y?null:qe().distance(h).strength(n).id(v=>v.ref_id)).alpha(1).restart(),pe);let ne=null;const _e=o.memo(()=>{const e=A(),[t,a,s]=S(n=>[n.data,n.selectedNodeRelativeIds,n.removeLink]),[i,r]=S(n=>[n.selectionGraphData,n.setSelectionData]);o.useEffect(()=>{if(i.nodes.length>0)return;const n=((t==null?void 0:t.nodes)||[]).filter(f=>a.includes(f.ref_id)||f.ref_id===(e==null?void 0:e.ref_id)).map(f=>{const u=f.ref_id===(e==null?void 0:e.ref_id)?{fx:0,fy:0,fz:0}:{};return{...f,x:0,y:0,z:0,...u}}),c=(t==null?void 0:t.links.filter(f=>n.some(u=>u.ref_id===f.target)&&n.some(u=>u.ref_id===f.source)))||[];r({nodes:n,links:c})},[t,e,a,i.nodes.length,r]),o.useEffect(()=>{ne=tn([...i.nodes],[...i.links],{numDimensions:2,forceLinkStrength:.1,forceCenterStrength:.1,forceChargeStrength:20,velocityDecay:.9})},[i]),E(()=>{ne&&ne.tick()});const l=n=>{const c=n.target===(e==null?void 0:e.ref_id)?n.source:n.target,h=i.nodes.filter(u=>u.ref_id!==c),f=i.links.filter(u=>u.ref_id!==n.ref_id);r({nodes:h,links:f}),s(n.ref_id,c)};return d.jsxs(d.Fragment,{children:[d.jsx(be,{fog:!0,lineWidth:.9,children:i.links.map(n=>d.jsx(Qt,{link:n,onRemove:()=>l(n),title:n.edge_type},n.ref_id))},`selection-links-${i==null?void 0:i.links.length}`),i.nodes.map(n=>d.jsx(ve,{node:n},`${n.ref_id}-compact`))]})});_e.displayName="SelectionDataNodes";const nn={font:"/fonts/Inter-Bold.woff",characters:"abcdefghijklmnopqrstuvwxyz0123456789!",fontSize:2,letterSpacing:-.05,lineHeight:1,"material-toneMapped":!1},je=o.memo(({node:e,hide:t})=>{const a=o.useRef(null),s=A(),[i,r]=S(y=>[y.selectedNodeRelativeIds,y.nodeTypes]),l=i.includes((e==null?void 0:e.ref_id)||""),n=!!s&&(s==null?void 0:s.ref_id)===e.ref_id,c=S(y=>y.showSelectionGraph);E(({camera:y})=>{a!=null&&a.current&&(a.current.quaternion.copy(y.quaternion),c&&a.current.position.set(e.x,e.y,e.z))});const h=o.useMemo(()=>((e.edge_count||1)*4,(e.edge_count||1)*4),[e.edge_count,n,l,c]),f=o.useMemo(()=>s&&!n&&!l?.1:1,[n,s,l]),u=Y[r.indexOf(e.node_type)]||Y[0],g=s?(s==null?void 0:s.ref_id)===e.ref_id:!0;return d.jsx(ye,{ref:a,anchorX:"center",anchorY:"middle",color:u,fillOpacity:f,position:[e.x,e.y,e.z],scale:Math.min(h,10),userData:e,visible:!t&&g,...nn,children:e.name})});je.displayName="TextNode";const ke=o.memo(()=>{const[e,t,a,s,i,r]=S(u=>[u.data,u.selectedNode,u.setHoveredNode,u.showSelectionGraph,u.selectionGraphData,u.setSelectedNode]),l=o.useCallback(u=>!!(s&&!i.nodes.find(g=>g.ref_id===u.ref_id)),[s,i]),n=o.useCallback(u=>{const g=u==null?void 0:u[0];g&&g.userData&&(l(g.userData)||r((g==null?void 0:g.userData)||null))},[l,r]),c=o.useCallback(u=>{u.stopPropagation(),a(null)},[a]),h=o.useCallback(u=>{var C;const y=u.intersections.map(v=>v.object)[0];if((C=y==null?void 0:y.userData)!=null&&C.ref_id){const v=y.userData;l(v)||(u.stopPropagation(),a(v))}},[a,l]),f=s&&!!t;return d.jsxs(dt,{filter:u=>u.filter(g=>{var y;return!!((y=g.userData)!=null&&y.ref_id)}),onChange:n,onPointerOut:c,onPointerOver:h,children:[s&&d.jsx(Pe,{}),e==null?void 0:e.nodes.map(u=>d.jsx(je,{hide:f,node:u},u.ref_id)),f&&d.jsx(_e,{},t.ref_id)]})});ke.displayName="Cubes";const on=({link:e})=>{var C,v;const t=A(),[a,s]=o.useState(new b(0,0,0)),[i,r]=o.useState(new b(0,0,0)),[l]=o.useState(Y[0]),n=S(k=>k.nodesNormalized);o.useEffect(()=>{var k,p,P,j,x,w;s(new b(((k=e.sourcePosition)==null?void 0:k.x)||0,((p=e.sourcePosition)==null?void 0:p.y)||0,((P=e.sourcePosition)==null?void 0:P.z)||0)),r(new b(((j=e.targetPosition)==null?void 0:j.x)||0,((x=e.targetPosition)==null?void 0:x.y)||0,((w=e.targetPosition)==null?void 0:w.z)||0))},[t,e]);const c=new b(0,1,0),h=new he(a,c,i),f=((C=n[e.source])==null?void 0:C.node_type)!==((v=n[e.target])==null?void 0:v.node_type),u=f?Y[1]:l,g=f?h.getPoints(50):[a,i],y=!t||t.ref_id===e.source||t.ref_id===e.target;return d.jsx(st,{color:u,opacity:.1,points:g.map(k=>k.toArray()),transparent:!0,visible:y})},H=e=>({close:{backgroundColor:"rgba(48, 51, 66, 1)",borderColor:"#fff",fontColor:"rgba(255, 255, 255, 1)"},focus:{backgroundColor:e?"rgba(255, 255, 255, 0.90);":"rgba(255, 255, 255, 0.90)",borderColor:e?"#FFDB58bb":"#fff",fontColor:"rgba(48, 51, 66, 1)"},menu:{backgroundColor:"#00000066",borderColor:e?"#ffffff66":"#5078f2",fontColor:e?"#ffffff66":"#fff"}}),sn=new b,Ne=o.memo(()=>{const e=o.useRef(null),{open:t}=J("editNodeName"),{open:a}=J("removeNode"),{open:s}=J("addEdgeToNode"),[i]=Ye(p=>[p.isAdmin]),r=S(p=>p.showSelectionGraph),[l,n,c,h]=S(p=>[p.selectionGraphData,p.setSelectionData,p.selectedNodeRelativeIds,p.setSelectedNodeRelativeIds]),[f]=S(p=>[p.data,p.setData]),u=A(),g=S(p=>p.setSelectedNode),y=S(p=>p.setShowSelectionGraph);E(()=>{v()});const C=o.useCallback(async()=>{try{if(u!=null&&u.ref_id){const p=await vt(u==null?void 0:u.ref_id,l.nodes.length||0),P=((p==null?void 0:p.edges)||[]).filter(x=>!l.links.some(w=>x.target===w.target&&x.source===w.source)),j=((p==null?void 0:p.nodes)||[]).filter(x=>!l.nodes.some(w=>x.ref_id===w.ref_id));n({links:[...l.links,...P.map(x=>({...x,sourcePosition:new b,targetPosition:new b}))],nodes:[...l.nodes,...j.map(x=>({...x,x:0,y:0,z:0}))]}),h([...new Set([...c,...j.map(x=>x.ref_id)])])}}catch(p){console.log(p)}},[u==null?void 0:u.ref_id,c,l.links,l.nodes,h,n]),v=o.useCallback(()=>{const p=r?l:f;if(e.current){const P=p==null?void 0:p.nodes.find(j=>j.ref_id===(u==null?void 0:u.ref_id));if(P){const j=sn.set(P==null?void 0:P.x,P==null?void 0:P.y,P==null?void 0:P.z);e.current.position.copy(j)}}},[u,r,l,f]),k=o.useMemo(()=>{const p=[{key:"control-key-1",colors:H(r).focus,icon:d.jsx(_t,{}),left:-80,className:"add",onClick:()=>{s()}},{key:"control-key-2",colors:H(r).focus,icon:d.jsx(ft,{}),left:-40,className:"edit",onClick:()=>{t()}},{key:"control-key-3",colors:H(r).focus,icon:d.jsx(we,{}),left:0,className:"delete",onClick:()=>{a()}}],P=[{key:"control-key-5",colors:H(!0).close,icon:d.jsx(Xe,{}),left:40,className:"exit",onClick:()=>{C()}},{key:"control-key-6",colors:H(!0).close,icon:d.jsx(jt,{}),left:40,className:"exit",onClick:()=>{g(null),y(!1)}}];return[...p,...P].map((j,x)=>({...j,left:-80+x*40}))},[i,r,s,t,a,y,g,C]);return u?d.jsx("group",{ref:e,children:d.jsx(Z,{center:!0,className:"control-panel",onClick:p=>p.stopPropagation(),onKeyDown:p=>p.stopPropagation(),onPointerDown:p=>p.stopPropagation(),onPointerOut:p=>p.stopPropagation(),onPointerOver:p=>p.stopPropagation(),onPointerUp:p=>p.stopPropagation(),sprite:!0,zIndexRange:[16777271,16777272],children:k.map(p=>d.jsx(rn,{backgroundColor:p.colors.backgroundColor,borderColor:p.colors.borderColor,className:p.className,fontColor:p.colors.fontColor,left:p.left,onClick:P=>{P.stopPropagation(),p.onClick()},children:p.icon},p.key))})}):null});Ne.displayName="NodeControls";const rn=W.div`
  position: fixed;
  top: -60px;
  left: ${e=>-7+e.left}px;
  width: 24px;
  height: 24px;

  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${e=>e.backgroundColor?e.backgroundColor:"#000000bb"};
  color: ${e=>e.fontColor?e.fontColor:"#ffffff"};
  border-radius: 100%;
  font-size: 16px;
  cursor: pointer;
  transition: opacity 0.4s;
  box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
`,Ee=o.memo(()=>d.jsx(d.Fragment,{children:d.jsx(Ne,{})}));Ee.displayName="NodeDetailsPanel";const an=()=>{const[e,t,a,s,i]=S(n=>[n.data,n.isFetching,n.graphStyle,n.showSelectionGraph,n.selectionGraphData]),r=o.useMemo(()=>s?0:a==="force"?.2:.4,[s,a]),l=o.useMemo(()=>((s?i.links:e==null?void 0:e.links)||[]).map(h=>d.jsx(on,{link:h},h.ref_id)),[e==null?void 0:e.links,i.links,s]);return t?null:d.jsxs(d.Fragment,{children:[d.jsx(ke,{}),!1,!s&&d.jsx(be,{fog:!0,limit:l.length,lineWidth:r,children:l}),d.jsx(Ee,{}),!1]})},oe=5e3,cn=()=>{const{fogColor:e}=Se("universe",{fogColor:Je}),t=me(r=>r.graphStyle),a=o.useRef(null),s=o.useRef(null),i=o.useRef(null);return E(({camera:r,clock:l})=>{const n=l.getElapsedTime();if(a.current){const h=Math.sin(n/8)*1e3;a.current.position.setZ(h)}if(s.current&&s.current.position.lerp(r.position,.5),i.current){const c=n*.5,h=Math.sin(c)*oe,f=Math.cos(c)*oe;i.current.position.set(h,0,f)}}),d.jsxs(d.Fragment,{children:[d.jsx("hemisphereLight",{args:[I.white,Ze,Ke]}),t!=="earth"&&d.jsx("fog",{args:[e,5,18e3],attach:"fog"}),d.jsx("ambientLight",{color:I.white,intensity:1}),d.jsx("pointLight",{ref:s,color:I.white,distance:4e3,intensity:5,position:[0,0,0]}),d.jsx("directionalLight",{ref:i,color:I.white,intensity:8,position:[oe,0,0]}),d.jsx("pointLight",{ref:a,color:I.white,distance:4e3,intensity:8,position:[0,0,0]})]})},ln=({fullSize:e=!0})=>{const t=Qe(a=>a.sidebarIsOpen);return d.jsx(un,{align:"center",className:et({"sidebar-is-open":t&&!e}),justify:"center",children:d.jsx(Pt,{color:I.SECONDARY_BLUE,size:64})})},un=W(X)`
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 0;
  background-color: ${I.black};
  z-index: 1;
`,dn=()=>d.jsx(Z,{children:d.jsx(mt,{})}),fn=()=>{const{universeColor:e}=Se("universe",{universeColor:I.black}),t=nt(),a=o.useMemo(()=>t!=null&&t.node_type?it(t.node_type):At,[t]);return d.jsxs(d.Fragment,{children:[d.jsx("color",{args:[e],attach:"background"}),d.jsx(cn,{}),d.jsx(Vt,{}),d.jsxs(xt,{children:[d.jsxs(yt,{autoClear:!1,multisampling:8,children:[d.jsx(bt,{darkness:.7,eskil:!1,offset:.05}),d.jsx(St,{luminanceThreshold:1,mipmapBlur:!0,resolutionX:ae.AUTO_SIZE,resolutionY:ae.AUTO_SIZE}),d.jsx(wt,{blendFunction:Ct.SCREEN,blur:!0,edgeStrength:4,hiddenEdgeColor:a,visibleEdgeColor:a})]}),d.jsx(an,{})]})]})};let se=null;const pn={aspect:window.innerWidth/window.innerHeight,far:3e4,near:1,position:[D.x,D.y,D.z]},gn=()=>{const[e,t,a]=[R(l=>l.setIsUserScrollingOnHtmlPanel),R(l=>l.setIsUserScrolling),R(l=>l.setUserMovedCamera)],s=me(l=>l.isFetching),i=o.useCallback(l=>{var h;const{target:n}=l,{offsetParent:c}=n;se&&clearTimeout(se),(h=c==null?void 0:c.classList)!=null&&h.contains("html-panel")&&c.clientHeight<c.scrollHeight&&e(!0),t(!0),a(!0),se=setTimeout(()=>{t(!1),e(!1)},200)},[t,e,a]),r=o.useCallback(l=>tt(l,"threeState"),[]);return d.jsxs(hn,{children:[d.jsx(o.Suspense,{fallback:null,children:d.jsx(rt,{camera:pn,id:"universe-canvas",onCreated:r,onWheel:i,children:d.jsxs(o.Suspense,{fallback:d.jsx(dn,{}),children:[d.jsx(pt,{}),d.jsx(gt,{}),d.jsx(ht,{}),d.jsx(fn,{})]})})}),s&&d.jsx(ln,{fullSize:!1})]})},hn=W(X)`
  flex: 1 1 100%;
  position: relative;
`,vn=o.memo(gn);export{vn as Universe};
