import{r as n,_ as V,aj as Te,ak as De,V as b,ai as U,am as ge,bi as Me,bj as Re,ax as Ae,ay as Le,az as Ge,aA as Ue,aC as Oe,au as Fe,j as d,aE as Be,f as W,h as T,F as X,bk as he,bl as $e,bm as He,bn as Ve,bo as We,bp as qe,bq as Y,x as Ye,af as Xe,i as me,aO as Ze,aP as Ke,aQ as Qe,k as Je,l as et,aR as tt,a3 as ot}from"./index-8c6e7d86.js";import{e as nt,m as re,b as N,g as R,u as xe,p as st,h as rt,i as it,H as Z,k as at,T as ye,l as be,n as ct,L as lt,C as ut,P as dt,A as ft,o as pt,q as gt,j as ht,r as mt,E as xt,V as yt,B as bt,R as ae,O as St,s as wt}from"./index-267bee38.js";import{l as Se,C as Pt}from"./react-toastify.esm-fcf4c1e7.js";import{u as A,a as S,f as Ct}from"./index-0408441e.js";import{D as we}from"./DeleteIcon-190da877.js";import{d as vt}from"./index.esm-5e8d1785.js";import{E as _t}from"./EditIcon-80229cd3.js";import{P as jt}from"./PlusIcon-b3e2a8bf.js";import{u as Q}from"./index-3a2e60ff.js";import"./index-51db6ff4.js";const ce=new ge,J=new Me,le=new Re,ee=new b;class kt extends Te{constructor(){super(),this.size=0,this.color=new De("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var t;return(t=this.instance.current)==null?void 0:t.geometry}raycast(t,i){var s,a;const r=this.instance.current;if(!r||!r.geometry)return;const l=r.userData.instances.indexOf(this.instanceKey);if(l===-1||l>r.geometry.drawRange.count)return;const o=(s=(a=t.params.Points)==null?void 0:a.threshold)!==null&&s!==void 0?s:1;if(le.set(this.getWorldPosition(ee),o),t.ray.intersectsSphere(le)===!1)return;ce.copy(r.matrixWorld).invert(),J.copy(t.ray).applyMatrix4(ce);const c=o/((this.scale.x+this.scale.y+this.scale.z)/3),h=c*c,p=J.distanceSqToPoint(ee);if(p<h){const u=new b;J.closestPointToPoint(ee,u),u.applyMatrix4(this.matrixWorld);const g=t.ray.origin.distanceTo(u);if(g<t.near||g>t.far)return;i.push({distance:g,distanceToRay:Math.sqrt(p),point:u,index:l,face:null,object:this})}}}let L,F;const Pe=n.createContext(null),ue=new ge,de=new b,Nt=n.forwardRef(({children:e,range:t,limit:i=1e3,...s},a)=>{const r=n.useRef(null),[l,o]=n.useState([]),[[c,h,p]]=n.useState(()=>[new Float32Array(i*3),Float32Array.from({length:i*3},()=>1),Float32Array.from({length:i},()=>1)]);n.useEffect(()=>{r.current.geometry.attributes.position.needsUpdate=!0}),N(()=>{for(r.current.updateMatrix(),r.current.updateMatrixWorld(),ue.copy(r.current.matrixWorld).invert(),r.current.geometry.drawRange.count=Math.min(i,t!==void 0?t:i,l.length),L=0;L<l.length;L++)F=l[L].current,F.getWorldPosition(de).applyMatrix4(ue),de.toArray(c,L*3),r.current.geometry.attributes.position.needsUpdate=!0,F.matrixWorldNeedsUpdate=!0,F.color.toArray(h,L*3),r.current.geometry.attributes.color.needsUpdate=!0,p.set([F.size],L),r.current.geometry.attributes.size.needsUpdate=!0});const u=n.useMemo(()=>({getParent:()=>r,subscribe:g=>(o(y=>[...y,g]),()=>o(y=>y.filter(P=>P.current!==g.current)))}),[]);return n.createElement("points",V({userData:{instances:l},matrixAutoUpdate:!1,ref:re([a,r]),raycast:()=>null},s),n.createElement("bufferGeometry",null,n.createElement("bufferAttribute",{attach:"attributes-position",count:c.length/3,array:c,itemSize:3,usage:U}),n.createElement("bufferAttribute",{attach:"attributes-color",count:h.length/3,array:h,itemSize:3,usage:U}),n.createElement("bufferAttribute",{attach:"attributes-size",count:p.length,array:p,itemSize:1,usage:U})),n.createElement(Pe.Provider,{value:u},e))}),Et=n.forwardRef(({children:e,...t},i)=>{n.useMemo(()=>nt({PositionPoint:kt}),[]);const s=n.useRef(),{subscribe:a,getParent:r}=n.useContext(Pe);return n.useLayoutEffect(()=>a(s),[]),n.createElement("positionPoint",V({instance:r(),instanceKey:s,ref:re([i,s])},t),e)}),zt=n.forwardRef(({children:e,positions:t,colors:i,sizes:s,stride:a=3,...r},l)=>{const o=n.useRef(null);return N(()=>{const c=o.current.geometry.attributes;c.position.needsUpdate=!0,i&&(c.color.needsUpdate=!0),s&&(c.size.needsUpdate=!0)}),n.createElement("points",V({ref:re([l,o])},r),n.createElement("bufferGeometry",null,n.createElement("bufferAttribute",{attach:"attributes-position",count:t.length/a,array:t,itemSize:a,usage:U}),i&&n.createElement("bufferAttribute",{attach:"attributes-color",count:i.length/a,array:i,itemSize:3,usage:U}),s&&n.createElement("bufferAttribute",{attach:"attributes-size",count:s.length/a,array:s,itemSize:1,usage:U})),e)}),It=n.forwardRef((e,t)=>e.positions instanceof Float32Array?n.createElement(zt,V({},e,{ref:t})):n.createElement(Nt,V({},e,{ref:t}))),Tt=(e,t,i,s,a)=>{const r=new Le,l=1e-5;r.absarc(l,l,l,-Math.PI/2,-Math.PI,!0),r.absarc(l,t-s*2,l,Math.PI,Math.PI/2,!0),r.absarc(e-s*2,t-s*2,l,Math.PI/2,0,!0),r.absarc(e-s*2,l,l,0,-Math.PI/2,!0);const o=new Ge(r,{depth:i-s*2,bevelEnabled:!0,bevelSegments:a,steps:2,bevelSize:s,bevelThickness:s,curveSegments:a});o.center();const c=[],h=o.getAttribute("normal"),p=o.getAttribute("position");for(let u=0;u<p.count;u+=1){const g=new b(h.getX(u),h.getY(u),h.getZ(u)),y=new b(p.getX(u),p.getY(u),p.getZ(u));let P=0,v=0;Math.abs(g.y)>.9?(P=y.x/e+.5,v=1-(y.z/i+.5)):Math.abs(g.x)>.9?(P=-y.z/i+.5,v=1-(-y.y/t+.5)):Math.abs(g.z)>.9&&(P=y.x/e+.5,v=1-(-y.y/t+.5)),c.push(P,v)}return o.setAttribute("uv",new Ue(c,2)),o};Tt(10,10,10,2,10);new Ae(10,10,10);const Dt=500,Mt=800,Rt=new b(0,0,0),At=16777215;let B=null;const Lt=500,ie=(e,t)=>{if(B)return null;B=setTimeout(()=>{B&&(clearTimeout(B),B=null)},Lt);const i=[];return e.forEach(a=>{const r=t.position.distanceTo(Rt.set(a.x,a.y,a.z));r<Mt&&i.push({id:a.ref_id||"",distance:r})}),i.sort((a,r)=>a.distance-r.distance).slice(0,Dt).map(a=>a.id)},M=new b(0,0,0),fe=100,Gt=600,Ut=2e3,te={x:172.7392402058252,y:-239.04675366094037,z:-2e3};let G,$;const Ot=4e3,Ft=2e3,Bt=e=>{const t=A(),i=S(m=>m.cameraFocusTrigger),s=R(m=>m.isUserDragging),a=R(m=>m.isUserScrolling),r=R(m=>m.setUserMovedCamera),l=S(m=>m.setNearbyNodeIds),o=S(m=>m.showSelectionGraph),c=S(m=>m.data),h=S(m=>m.graphStyle),{camera:p}=xe(),[u,g]=n.useState(!1),[y,P]=n.useState(!1),[v,E]=n.useState(fe),f=n.useMemo(()=>{if(o)return new b(0,0,0);const m=c==null?void 0:c.nodes.find(I=>I.ref_id===(t==null?void 0:t.ref_id));let _=new b(2e3,2e3,3e3);if(m&&c){const I=[],O=new b(m.x,m.y,m.z);let K=new b(0,0,0);I.map(q=>(K=K.add(new b(q.x,q.y,q.z).normalize()),q));const ze=m.edge_count?1-1/(m.edge_count+10):1,Ie=O.sub(K).multiplyScalar(.8*ze);_=O.add(Ie)}return _},[o,t,c]),C=n.useMemo(()=>{if(o)return new b(0,0,0);const m=c==null?void 0:c.nodes.find(_=>_.ref_id===(t==null?void 0:t.ref_id));return new b((m==null?void 0:m.x)||0,(m==null?void 0:m.y)||0,(m==null?void 0:m.z)||0)},[o,t,c]);n.useEffect(()=>{var m;o&&((m=e.current)==null||m.setLookAt(te.x,te.y,te.z,0,0,0,!1)),j()},[o]),n.useEffect(()=>{o?E(Ut):(t==null?void 0:t.node_type)==="topic"?E(Gt):E(fe)},[t,E,o]),n.useEffect(()=>{x()},[i]),n.useEffect(()=>{(s||a)&&(g(!0),P(!0))},[s,a,g,P]),n.useEffect(()=>{if(t)if(!o&&h==="earth"&&(e!=null&&e.current)){const m=e.current.camera.position.distanceTo(new b),_=Oe(C,-m/2);e.current.setLookAt(_.x,_.y,_.z,0,0,0,!0)}else G&&clearTimeout(G),G=setTimeout(()=>{P(!0),clearTimeout(G)},Ft),j();return()=>{G&&clearTimeout(G),$&&clearTimeout($)}},[t]),N(m=>{e.current&&(u||w(f,m.camera),y||z(C,m.camera))});const j=()=>{if(t){const m=p.position.distanceTo(f);st(m)}x()},x=()=>{g(!1),P(!1),r(!1),$&&clearTimeout($),$=setTimeout(()=>{g(!0),P(!0)},Ot)},w=(m,_)=>{if(_.position.distanceTo(m)<v)g(!0);else{_.position.lerp(m,.5);const O=ie((c==null?void 0:c.nodes)||[],p);O&&l(O)}},z=(m,_)=>{var I;(I=e==null?void 0:e.current)==null||I.setLookAt(_.position.x,_.position.y,_.position.z,m.x,m.y,m.z,!0)};return null},$t=1;let D=null;const Ht=(e,{enabled:t})=>{const i=A();Bt(e);const s=R(p=>p.isUserDragging),a=S(p=>p.disableCameraRotation),r=S(p=>p.data),l=S(p=>p.graphStyle),o=S(p=>p.graphRadius),c=S(p=>p.setNearbyNodeIds);n.useEffect(()=>{t||(D==null||D.kill(),D=null)},[t]);const h=n.useCallback(()=>{D==null||D.kill();const p={value:-244},u=rt.to(p,{duration:5,keyframes:{"0%":{value:10},"100%":{delay:2,ease:"Power4.easeIn",value:-200}},onComplete:()=>{D=null},onInterrupt(){u.kill()},onUpdate:()=>{var y;const{value:g}=p;if(e.current){const P=ie((r==null?void 0:r.nodes)||[],e.current.camera);P&&c(P),(y=e.current)==null||y.dolly(g,!1)}}});u.play(),D=u},[]);return n.useEffect(()=>{e.current&&o&&(l==="sphere"?(e.current.maxDistance=8e3,e.current.minDistance=200,e.current.setTarget(0,0,500,!0)):(e.current.maxDistance=e.current.getDistanceToFitSphere(o+200),e.current.minDistance=100))},[o,l,e]),n.useEffect(()=>{h()},[h,l]),n.useEffect(()=>{!i&&e.current&&e.current.setLookAt(M.x,M.y,M.z,0,0,0,!0)},[i]),N((p,u)=>{e.current&&(!a&&!s&&(e.current.azimuthAngle+=$t*u*Fe.DEG2RAD),e.current.update(u))}),null},Vt=({disableAnimations:e})=>{const t=n.useRef(null),i=S(g=>g.graphStyle),s=S(g=>g.data),a=S(g=>g.setNearbyNodeIds),r=S(g=>g.setDisableCameraRotation),[l]=n.useState(.8),{camera:o}=xe(),[c,h,p,u]=R(g=>[g.isUserDragging,g.setIsUserDragging,g.isUserScrolling,g.isUserScrollingOnHtmlPanel]);return Ht(t,{enabled:!e&&!p&&!c}),n.useEffect(()=>{t.current&&t.current.setLookAt(M.x,M.y,M.z,0,0,0,!0)},[i]),n.useEffect(()=>{if(!c){const g=ie((s==null?void 0:s.nodes)||[],o);g&&a(g)}},[o,o.position,o.position.x,o.position.y,o.position.z,s==null?void 0:s.nodes,a,c]),n.useEffect(()=>{c&&r(!0)},[c,r]),d.jsx(it,{ref:t,boundaryEnclosesCamera:!0,enabled:!u,makeDefault:!0,maxDistance:12e3,minDistance:100,onEnd:()=>h(!1),onStart:()=>h(!0),smoothTime:l})},Wt=["#ffffff","#ffffcc","#ccffcc","#ffccff","#ccccff","#ffd699","#c2f0c2","#ff6666","#99ccff","#ffb3b3"],qt=new b,Yt=({position:e,userData:t})=>{const i=n.useRef(null),[s,a]=S(o=>[o.selectedNode,o.nodeTypes]),r=S(o=>o.showSelectionGraph);return N(()=>{if(r&&i.current){const o=qt.set((t==null?void 0:t.x)||0,(t==null?void 0:t.y)||0,(t==null?void 0:t.z)||0);i.current.position.copy(o)}}),n.useEffect(()=>function(){i.current&&i.current.clear()},[i]),(s==null?void 0:s.ref_id)===(t==null?void 0:t.ref_id)?null:d.jsx("group",{ref:i,position:e,children:d.jsx(Z,{center:!0,sprite:!0,zIndexRange:[0,0],children:d.jsx(Xt,{bgColor:Wt[Math.max(a.indexOf(t.node_type),0)],children:t.node_type})})})},Ce=n.memo(()=>{const e=S(r=>r.data),t=S(r=>r.showSelectionGraph),i=S(r=>r.selectionGraphData),s=S(r=>r.selectedNodeRelativeIds),a=n.useMemo(()=>(t?i.nodes:(e==null?void 0:e.nodes)||[]).filter(c=>s.includes((c==null?void 0:c.ref_id)||"")).slice(0,Be).map(c=>{const h=new b((c==null?void 0:c.x)||0,(c==null?void 0:c.y)||0,(c==null?void 0:c.z)||0),p=[];return d.jsx(Yt,{position:h,relativeIds:p,userData:c},`node-badge-${c.ref_id}`)}),[s,e==null?void 0:e.nodes,t,i]);return d.jsx(n.Fragment,{children:a.length?a:null},"node-badges")});Ce.displayName="RelevanceBadges";const Xt=W.div`
  position: absolute;
  left: 50%;
  top: 20%;
  transform: translateX(-50%) translateY(200%);
  padding: 0 4px;
  height: 14px;
  background: ${e=>e.bgColor};
  color: ${T.BG1};
  font-size: 8px;
  font-style: normal;
  font-weight: 800;
  line-height: 14px;
`,Zt=({position:e,title:t,onRemove:i})=>{const s=n.useRef(null);return n.useEffect(()=>function(){s.current&&s.current.clear()},[s]),d.jsx("group",{ref:s,position:e,children:d.jsx(Z,{center:!0,sprite:!0,children:d.jsxs(Kt,{direction:"row",justify:"center",onClick:a=>{a.stopPropagation()},onPointerOut:a=>{a.stopPropagation()},onPointerOver:a=>{a.stopPropagation()},children:[d.jsx("span",{children:t}),d.jsx(X,{className:"icon",onClick:i,children:d.jsx(we,{})})]})})})},Kt=W(X)`
  text-align: center;

  outline-offset: 0px;
  background: rgba(0, 0, 0, 0.75);
  color: #eee;
  cursor: pointer;
  transition: font-size 0.4s, outline 0.4s;
  align-items: center;
  justify-content: center;
  font-family: Barlow;
  font-size: 16px;
  font-style: normal;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);

  &:hover {
    outline-offset: 4px;
    span {
      opacity: 0.1;
    }

    .icon {
      display: flex;
    }
  }

  .icon {
    position: absolute;
    width: 24px;
    height: 24px;
    /* bottom: 100%; */
    display: none;
    color: #000;
    border-radius: 40px;
    justify-content: center;
    align-items: center;
    background: #ffffff;
    color: #000;
    border-radius: 100%;
    font-size: 16px;
    cursor: pointer;
    transition: opacity 0.4s;
    box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
  }

  .badge-wrapper {
    position: absolute;
    top: -7px;
    left: -14px;
  }
`,Qt=(e,t)=>{const i=e.reduce((a,r,l)=>{if(l<e.length-1){const o=e[l+1],c=new b().subVectors(o,r).length();return a+c}return a},0);let s=0;for(let a=0;a<e.length-1;a+=1){const r=e[a],l=e[a+1],o=new b().subVectors(l,r).length();if(t<=(s+o)/i){const c=(t*i-s)/o;return new b().lerpVectors(r,l,c)}s+=o}return e[e.length-1]},Jt=({link:e,title:t,onRemove:i})=>{const s=n.useRef(null),a=n.useRef(null),r=A(),[l,o]=n.useState(new b(0,0,0)),[c,h]=n.useState(new b(0,0,0)),[p,u]=n.useState("#ff13c9"),[g]=S(x=>[x.selectionGraphData]),[y,P]=n.useState(0);N(()=>{P(x=>(x+.01)%1)}),n.useEffect(()=>{var x,w,z,m,_,I;o(new b(((x=e.sourcePosition)==null?void 0:x.x)||0,((w=e.sourcePosition)==null?void 0:w.y)||0,((z=e.sourcePosition)==null?void 0:z.z)||0)),h(new b(((m=e.targetPosition)==null?void 0:m.x)||0,((_=e.targetPosition)==null?void 0:_.y)||0,((I=e.targetPosition)==null?void 0:I.z)||0)),u("#ff13c9")},[r,e]);const v=new b().addVectors(l,c).multiplyScalar(.5);N(()=>{if(s.current){const x=g.nodes.find(z=>z.ref_id===e.source),w=g.nodes.find(z=>z.ref_id===e.target);s.current.start.set((x==null?void 0:x.x)||0,(x==null?void 0:x.y)||0,(x==null?void 0:x.z)||0),s.current.end.set((w==null?void 0:w.x)||0,(w==null?void 0:w.y)||0,(w==null?void 0:w.z)||0),o(new b((x==null?void 0:x.x)||0,(x==null?void 0:x.y)||0,(x==null?void 0:x.z)||0)),h(new b((w==null?void 0:w.x)||0,(w==null?void 0:w.y)||0,(w==null?void 0:w.z)||0))}});const E=new b(0,0,0),f=![e.target,e.source].includes((r==null?void 0:r.ref_id)||""),C=new he(l,E,c),j=f?C.getPoints(2):[l,c];return d.jsxs(d.Fragment,{children:[d.jsx(at,{ref:s,color:"transparent",end:c,start:l}),d.jsxs(It,{limit:1,range:1,children:[d.jsx("pointsMaterial",{vertexColors:!0}),d.jsx(Et,{ref:a,color:p,position:Qt(j,y),size:20})]}),d.jsx(Zt,{onRemove:i,position:v,title:t})]})},eo={font:"/fonts/Inter-Bold.woff",characters:"abcdefghijklmnopqrstuvwxyz0123456789!",fontSize:8,letterSpacing:-.05,lineHeight:1,"material-toneMapped":!1},ve=n.memo(({node:e})=>{const t=n.useRef(null),i=A(),a=S(h=>h.selectedNodeRelativeIds).includes((e==null?void 0:e.ref_id)||""),r=!!i&&(i==null?void 0:i.ref_id)===e.ref_id,l=S(h=>h.showSelectionGraph);N(({camera:h})=>{t!=null&&t.current&&(t.current.quaternion.copy(h.quaternion),l&&t.current.position.set(e.x,e.y,e.z))});const o=n.useMemo(()=>((e.edge_count||1)*4,(e.edge_count||1)*4),[e.edge_count,r,a,l]),c=n.useMemo(()=>1,[r,i,a]);return d.jsx(ye,{ref:t,anchorX:"center",anchorY:"middle",color:T.white,fillOpacity:c,position:[e.x,e.y,e.z],scale:Math.min(o,10),userData:e,visible:!0,...eo,children:e.name})});ve.displayName="SelectionNode";const pe=$e().stop(),k={numDimensions:3,velocityDecay:.9,forceChargeStrength:-20,forceChargeMinDistance:150,forceChargeMaxDistance:8e3,forceLinkStrength:.04,forceCenterStrength:.85,disableCollide:!1,disableCenter:!1,disableLink:!1,disableCharge:!1,forceCollideRadiusMethod:e=>((e.edge_count||1)+20)*6+200,forceLinkDistanceMethod:()=>150},to=(e,t,{numDimensions:i=k.numDimensions,velocityDecay:s=k.velocityDecay,forceChargeStrength:a=k.forceChargeStrength,forceChargeMinDistance:r=k.forceChargeMinDistance,forceChargeMaxDistance:l=k.forceChargeMaxDistance,forceLinkStrength:o=k.forceLinkStrength,forceCenterStrength:c=k.forceCenterStrength,forceLinkDistanceMethod:h=k.forceLinkDistanceMethod,forceCollideRadiusMethod:p=k.forceCollideRadiusMethod,disableCollide:u=k.disableCollide,disableCenter:g=k.disableCenter,disableLink:y=k.disableLink,disableCharge:P=k.disableCharge})=>(pe.alpha(1).stop().numDimensions(i).velocityDecay(s).force("collide",u?null:He().radius(p).iterations(1)).force("center",g?null:Ve().strength(c)).force("charge",P?null:We().strength(a).distanceMin(r).distanceMax(l)).nodes(e).force("link",y?null:qe().distance(h).strength(o).id(v=>v.ref_id)).alpha(1).restart(),pe);let oe=null;const _e=n.memo(()=>{const e=A(),[t,i,s]=S(o=>[o.data,o.selectedNodeRelativeIds,o.removeLink]),[a,r]=S(o=>[o.selectionGraphData,o.setSelectionData]);n.useEffect(()=>{if(a.nodes.length>0)return;const o=((t==null?void 0:t.nodes)||[]).filter(p=>i.includes(p.ref_id)||p.ref_id===(e==null?void 0:e.ref_id)).map(p=>{const u=p.ref_id===(e==null?void 0:e.ref_id)?{fx:0,fy:0,fz:0}:{};return{...p,x:0,y:0,z:0,...u}}),c=(t==null?void 0:t.links.filter(p=>o.some(u=>u.ref_id===p.target)&&o.some(u=>u.ref_id===p.source)))||[];r({nodes:o,links:c})},[t,e,i,a.nodes.length,r]),n.useEffect(()=>{oe=to([...a.nodes],[...a.links],{numDimensions:2,forceLinkStrength:.1,forceCenterStrength:.1,forceChargeStrength:20,velocityDecay:.9})},[a]),N(()=>{oe&&oe.tick()});const l=o=>{const c=o.target===(e==null?void 0:e.ref_id)?o.source:o.target,h=a.nodes.filter(u=>u.ref_id!==c),p=a.links.filter(u=>u.ref_id!==o.ref_id);r({nodes:h,links:p}),s(o.ref_id,c)};return d.jsxs(d.Fragment,{children:[d.jsx(be,{fog:!0,lineWidth:.9,children:a.links.map(o=>d.jsx(Jt,{link:o,onRemove:()=>l(o),title:o.edge_type},o.ref_id))},`selection-links-${a==null?void 0:a.links.length}`),a.nodes.map(o=>d.jsx(ve,{node:o},`${o.ref_id}-compact`))]})});_e.displayName="SelectionDataNodes";const oo={font:"/fonts/Inter-Bold.woff",characters:"abcdefghijklmnopqrstuvwxyz0123456789!",fontSize:2,letterSpacing:-.05,lineHeight:1,"material-toneMapped":!1},je=n.memo(({node:e,hide:t})=>{const i=n.useRef(null),s=A(),[a,r]=S(y=>[y.selectedNodeRelativeIds,y.nodeTypes]),l=a.includes((e==null?void 0:e.ref_id)||""),o=!!s&&(s==null?void 0:s.ref_id)===e.ref_id,c=S(y=>y.showSelectionGraph);N(({camera:y})=>{i!=null&&i.current&&(i.current.quaternion.copy(y.quaternion),c&&i.current.position.set(e.x,e.y,e.z))});const h=n.useMemo(()=>((e.edge_count||1)*4,(e.edge_count||1)*4),[e.edge_count,o,l,c]),p=n.useMemo(()=>s&&!o&&!l?.1:1,[o,s,l]),u=Y[r.indexOf(e.node_type)]||Y[0],g=s?(s==null?void 0:s.ref_id)===e.ref_id:!0;return d.jsx(ye,{ref:i,anchorX:"center",anchorY:"middle",color:u,fillOpacity:p,position:[e.x,e.y,e.z],scale:Math.min(h,10),userData:e,visible:!t&&g,...oo,children:e.name})});je.displayName="TextNode";const ke=n.memo(()=>{const[e,t,i,s,a,r]=S(u=>[u.data,u.selectedNode,u.setHoveredNode,u.showSelectionGraph,u.selectionGraphData,u.setSelectedNode]),l=n.useCallback(u=>!!(s&&!a.nodes.find(g=>g.ref_id===u.ref_id)),[s,a]),o=n.useCallback(u=>{const g=u==null?void 0:u[0];g&&g.userData&&(l(g.userData)||r((g==null?void 0:g.userData)||null))},[l,r]),c=n.useCallback(u=>{u.stopPropagation(),i(null)},[i]),h=n.useCallback(u=>{var P;const y=u.intersections.map(v=>v.object)[0];if((P=y==null?void 0:y.userData)!=null&&P.ref_id){const v=y.userData;l(v)||(u.stopPropagation(),i(v))}},[i,l]),p=s&&!!t;return d.jsxs(ct,{filter:u=>u.filter(g=>{var y;return!!((y=g.userData)!=null&&y.ref_id)}),onChange:o,onPointerOut:c,onPointerOver:h,children:[s&&d.jsx(Ce,{}),e==null?void 0:e.nodes.map(u=>d.jsx(je,{hide:p,node:u},u.ref_id)),p&&d.jsx(_e,{},t.ref_id)]})});ke.displayName="Cubes";const no=({link:e,animated:t})=>{var v,E;const i=A(),[s,a]=n.useState(new b(0,0,0)),[r,l]=n.useState(new b(0,0,0)),[o]=n.useState(Y[0]),c=S(f=>f.nodesNormalized);n.useEffect(()=>{var f,C,j,x,w,z;a(new b(((f=e.sourcePosition)==null?void 0:f.x)||0,((C=e.sourcePosition)==null?void 0:C.y)||0,((j=e.sourcePosition)==null?void 0:j.z)||0)),l(new b(((x=e.targetPosition)==null?void 0:x.x)||0,((w=e.targetPosition)==null?void 0:w.y)||0,((z=e.targetPosition)==null?void 0:z.z)||0))},[i,e]);const h=new b(0,1,0),p=new he(s,h,r),u=((v=c[e.source])==null?void 0:v.node_type)!==((E=c[e.target])==null?void 0:E.node_type),g=u?Y[1]:o,y=u?p.getPoints(50):[s,r],P=!i||i.ref_id===e.source||i.ref_id===e.target;return d.jsx(lt,{color:g,opacity:.1,points:y.map(f=>f.toArray()),transparent:!0,visible:P})},H=e=>({close:{backgroundColor:"rgba(48, 51, 66, 1)",borderColor:"#fff",fontColor:"rgba(255, 255, 255, 1)"},focus:{backgroundColor:e?"rgba(255, 255, 255, 0.90);":"rgba(255, 255, 255, 0.90)",borderColor:e?"#FFDB58bb":"#fff",fontColor:"rgba(48, 51, 66, 1)"},menu:{backgroundColor:"#00000066",borderColor:e?"#ffffff66":"#5078f2",fontColor:e?"#ffffff66":"#fff"}}),so=new b,Ne=n.memo(()=>{const e=n.useRef(null),{open:t}=Q("editNodeName"),{open:i}=Q("removeNode"),{open:s}=Q("addEdgeToNode"),[a]=Ye(f=>[f.isAdmin]),r=S(f=>f.showSelectionGraph),[l,o,c,h]=S(f=>[f.selectionGraphData,f.setSelectionData,f.selectedNodeRelativeIds,f.setSelectedNodeRelativeIds]),[p]=S(f=>[f.data,f.setData]),u=A(),g=S(f=>f.setSelectedNode),y=S(f=>f.setShowSelectionGraph);N(()=>{v()});const P=n.useCallback(async()=>{try{if(u!=null&&u.ref_id){const f=await Ct(u==null?void 0:u.ref_id,l.nodes.length||0),C=((f==null?void 0:f.edges)||[]).filter(x=>!l.links.some(w=>x.target===w.target&&x.source===w.source)),j=((f==null?void 0:f.nodes)||[]).filter(x=>!l.nodes.some(w=>x.ref_id===w.ref_id));o({links:[...l.links,...C.map(x=>({...x,sourcePosition:new b,targetPosition:new b}))],nodes:[...l.nodes,...j.map(x=>({...x,x:0,y:0,z:0}))]}),h([...new Set([...c,...j.map(x=>x.ref_id)])])}}catch(f){console.log(f)}},[u==null?void 0:u.ref_id,c,l.links,l.nodes,h,o]),v=n.useCallback(()=>{const f=r?l:p;if(e.current){const C=f==null?void 0:f.nodes.find(j=>j.ref_id===(u==null?void 0:u.ref_id));if(C){const j=so.set(C==null?void 0:C.x,C==null?void 0:C.y,C==null?void 0:C.z);e.current.position.copy(j)}}},[u,r,l,p]),E=n.useMemo(()=>{const f=[{key:"control-key-1",colors:H(r).focus,icon:d.jsx(jt,{}),left:-80,className:"add",onClick:()=>{s()}},{key:"control-key-2",colors:H(r).focus,icon:d.jsx(_t,{}),left:-40,className:"edit",onClick:()=>{t()}},{key:"control-key-3",colors:H(r).focus,icon:d.jsx(we,{}),left:0,className:"delete",onClick:()=>{i()}}],C=[{key:"control-key-5",colors:H(!0).close,icon:d.jsx(Xe,{}),left:40,className:"exit",onClick:()=>{P()}},{key:"control-key-6",colors:H(!0).close,icon:d.jsx(vt,{}),left:40,className:"exit",onClick:()=>{g(null),y(!1)}}];return[...f,...C].map((j,x)=>({...j,left:-80+x*40}))},[a,r,s,t,i,y,g,P]);return u?d.jsx("group",{ref:e,children:d.jsx(Z,{center:!0,className:"control-panel",onClick:f=>f.stopPropagation(),onKeyDown:f=>f.stopPropagation(),onPointerDown:f=>f.stopPropagation(),onPointerOut:f=>f.stopPropagation(),onPointerOver:f=>f.stopPropagation(),onPointerUp:f=>f.stopPropagation(),sprite:!0,zIndexRange:[16777271,16777272],children:E.map(f=>d.jsx(ro,{backgroundColor:f.colors.backgroundColor,borderColor:f.colors.borderColor,className:f.className,fontColor:f.colors.fontColor,left:f.left,onClick:C=>{C.stopPropagation(),f.onClick()},children:f.icon},f.key))})}):null});Ne.displayName="NodeControls";const ro=W.div`
  position: fixed;
  top: -60px;
  left: ${e=>-7+e.left}px;
  width: 24px;
  height: 24px;

  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${e=>e.backgroundColor?e.backgroundColor:"#000000bb"};
  color: ${e=>e.fontColor?e.fontColor:"#ffffff"};
  border-radius: 100%;
  font-size: 16px;
  cursor: pointer;
  transition: opacity 0.4s;
  box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
`,Ee=n.memo(()=>d.jsx(d.Fragment,{children:d.jsx(Ne,{})}));Ee.displayName="NodeDetailsPanel";const io=()=>{const[e,t,i,s,a]=S(o=>[o.data,o.isFetching,o.graphStyle,o.showSelectionGraph,o.selectionGraphData]),r=n.useMemo(()=>s?0:i==="force"?.2:.4,[s,i]),l=n.useMemo(()=>((s?a.links:e==null?void 0:e.links)||[]).map(h=>d.jsx(no,{link:h},h.ref_id)),[e==null?void 0:e.links,a.links,s]);return t?null:d.jsxs(d.Fragment,{children:[d.jsx(ke,{}),!1,!s&&d.jsx(be,{fog:!0,limit:l.length,lineWidth:r,children:l}),d.jsx(Ee,{}),!1]})},ne=5e3,ao=()=>{const{fogColor:e}=Se("universe",{fogColor:Qe}),t=me(r=>r.graphStyle),i=n.useRef(null),s=n.useRef(null),a=n.useRef(null);return N(({camera:r,clock:l})=>{const o=l.getElapsedTime();if(i.current){const h=Math.sin(o/8)*1e3;i.current.position.setZ(h)}if(s.current&&s.current.position.lerp(r.position,.5),a.current){const c=o*.5,h=Math.sin(c)*ne,p=Math.cos(c)*ne;a.current.position.set(h,0,p)}}),d.jsxs(d.Fragment,{children:[d.jsx("hemisphereLight",{args:[T.white,Ze,Ke]}),t!=="earth"&&d.jsx("fog",{args:[e,5,18e3],attach:"fog"}),d.jsx("ambientLight",{color:T.white,intensity:1}),d.jsx("pointLight",{ref:s,color:T.white,distance:4e3,intensity:5,position:[0,0,0]}),d.jsx("directionalLight",{ref:a,color:T.white,intensity:8,position:[ne,0,0]}),d.jsx("pointLight",{ref:i,color:T.white,distance:4e3,intensity:8,position:[0,0,0]})]})},co=({fullSize:e=!0})=>{const t=Je(i=>i.sidebarIsOpen);return d.jsx(lo,{align:"center",className:et({"sidebar-is-open":t&&!e}),justify:"center",children:d.jsx(Pt,{color:T.SECONDARY_BLUE,size:64})})},lo=W(X)`
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 0;
  background-color: ${T.black};
  z-index: 1;
`,uo=()=>d.jsx(Z,{children:d.jsx(gt,{})}),fo=()=>{const{universeColor:e}=Se("universe",{universeColor:T.black}),t=ot(),i=n.useMemo(()=>t!=null&&t.node_type?ht(t.node_type):At,[t]);return d.jsxs(d.Fragment,{children:[d.jsx("color",{args:[e],attach:"background"}),d.jsx(ao,{}),d.jsx(Vt,{}),d.jsxs(mt,{children:[d.jsxs(xt,{autoClear:!1,multisampling:8,children:[d.jsx(yt,{darkness:.7,eskil:!1,offset:.05}),d.jsx(bt,{luminanceThreshold:1,mipmapBlur:!0,resolutionX:ae.AUTO_SIZE,resolutionY:ae.AUTO_SIZE}),d.jsx(St,{blendFunction:wt.SCREEN,blur:!0,edgeStrength:4,hiddenEdgeColor:i,visibleEdgeColor:i})]}),d.jsx(io,{})]})]})};let se=null;const po={aspect:window.innerWidth/window.innerHeight,far:3e4,near:1,position:[M.x,M.y,M.z]},go=()=>{const[e,t,i]=[R(l=>l.setIsUserScrollingOnHtmlPanel),R(l=>l.setIsUserScrolling),R(l=>l.setUserMovedCamera)],s=me(l=>l.isFetching),a=n.useCallback(l=>{var h;const{target:o}=l,{offsetParent:c}=o;se&&clearTimeout(se),(h=c==null?void 0:c.classList)!=null&&h.contains("html-panel")&&c.clientHeight<c.scrollHeight&&e(!0),t(!0),i(!0),se=setTimeout(()=>{t(!1),e(!1)},200)},[t,e,i]),r=n.useCallback(l=>tt(l,"threeState"),[]);return d.jsxs(ho,{children:[d.jsx(n.Suspense,{fallback:null,children:d.jsx(ut,{camera:po,id:"universe-canvas",onCreated:r,onWheel:a,children:d.jsxs(n.Suspense,{fallback:d.jsx(uo,{}),children:[d.jsx(dt,{}),d.jsx(ft,{}),d.jsx(pt,{}),d.jsx(fo,{})]})})}),s&&d.jsx(co,{fullSize:!1})]})},ho=W(X)`
  flex: 1 1 100%;
  position: relative;
`,jo=n.memo(go);export{jo as Universe};
