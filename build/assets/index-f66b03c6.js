import{aj as te,r as c,ad as B,_ as le,ak as Se,al as tt,am as Re,an as st,ao as Y,Z as w,ap as D,aq as nt,ar as ot,as as rt,at as it,au as at,av as ct,a5 as A,i as g,aw as lt,ax as ut,j as u,ay as K,f as k,h as I,F as de,az as Ne,aA as dt,l as pt,aB as Ge,aC as ft,aD as mt,aE as ht,k as Oe,a0 as gt,aF as q,aG as xt,aH as yt,aI as bt,aJ as oe,H as St,B as re,y as wt,aK as Mt,W as vt,aL as jt}from"./index-1f32104b.js";import{u as pe,a as fe,e as _t,m as $e,b as E,g as me,T as Ct,L as Pt,D as It,U as At,C as Et}from"./constant-08126cb0.js";import{u as R,p as Tt,g as zt,C as kt,S as Rt,H as he,a as Nt,b as Ue,c as Gt,E as Ot,P as $t,A as Ut,d as Ft,L as Lt,e as Bt,f as Ht,V as Wt,B as Vt,R as we,O as qt,h as Yt}from"./EditIcon-c92ce1ce.js";import{A as Kt,k as Zt}from"./react-toastify.esm-778eaf5b.js";import{f as Xt,P as Qt,L as Jt}from"./constants-ee232938.js";import{q as Fe}from"./generateCategoricalChart-a5e66e71.js";import{T as Dt}from"./index-aa5d4f0e.js";import{e as es,c as ts}from"./index.esm-b5bec20a.js";import{M as ss,A as ns,P as os,O as rs}from"./index-b1b6a206.js";import{P as is}from"./PlusIcon-9f16296c.js";import{a as as}from"./Popover-9aa0b185.js";import"./useSlotProps-f66c36b0.js";import"./InfoIcon-651502b1.js";import"./NoFilterResultIcon-46c15fc2.js";import"./index-fa5ded45.js";import"./index-c834de04.js";import"./index-dd3c818a.js";import"./index-e9915fcc.js";import"./index-a43ddeb1.js";import"./Popper-388cba6e.js";import"./CheckIcon-b6ba1038.js";const Me=e=>e===Object(e)&&!Array.isArray(e)&&typeof e!="function";function O(e,t){const d=pe(r=>r.gl),s=fe(te,Me(e)?Object.values(e):e);if(c.useLayoutEffect(()=>{t==null||t(s)},[t]),c.useEffect(()=>{(Array.isArray(s)?s:[s]).forEach(d.initTexture)},[d,s]),Me(e)){const r=Object.keys(e),i={};return r.forEach(n=>Object.assign(i,{[n]:s[r.indexOf(n)]})),i}else return s}O.preload=e=>fe.preload(te,e);O.clear=e=>fe.clear(te,e);B.func.isRequired,B.arrayOf(B.oneOfType([B.element,B.func])).isRequired;const ve=new Y,je=new Y,Z=[],H=new nt;class cs extends tt{constructor(){super(),this.color=new Re("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var t;return(t=this.instance.current)==null?void 0:t.geometry}raycast(t,d){const s=this.instance.current;if(!s||!s.geometry||!s.material)return;H.geometry=s.geometry;const r=s.matrixWorld,i=s.userData.instances.indexOf(this.instanceKey);if(!(i===-1||i>s.count)){s.getMatrixAt(i,ve),je.multiplyMatrices(r,ve),H.matrixWorld=je,s.material instanceof st?H.material.side=s.material.side:H.material.side=s.material[0].side,H.raycast(t,Z);for(let n=0,l=Z.length;n<l;n++){const a=Z[n];a.instanceId=i,a.object=this,d.push(a)}Z.length=0}}}const Le=c.createContext(null),_e=new Y,Ce=new Y,ls=new Y,Pe=new w,Ie=new D,Ae=new w,Be=c.forwardRef(({context:e,children:t,...d},s)=>{c.useMemo(()=>_t({PositionMesh:cs}),[]);const r=c.useRef(),{subscribe:i,getParent:n}=c.useContext(e||Le);return c.useLayoutEffect(()=>i(r),[]),c.createElement("positionMesh",le({instance:n(),instanceKey:r,ref:$e([s,r])},d),t)}),us=c.forwardRef(({children:e,range:t,limit:d=1e3,frames:s=1/0,...r},i)=>{const[{context:n,instance:l}]=c.useState(()=>{const S=c.createContext(null);return{context:S,instance:c.forwardRef((M,P)=>c.createElement(Be,le({context:S},M,{ref:P})))}}),a=c.useRef(null),[p,h]=c.useState([]),[[f,o]]=c.useState(()=>{const S=new Float32Array(d*16);for(let M=0;M<d;M++)ls.identity().toArray(S,M*16);return[S,new Float32Array([...new Array(d*3)].map(()=>1))]});c.useEffect(()=>{a.current.instanceMatrix.needsUpdate=!0});let m=0,b=0;E(()=>{if(s===1/0||m<s){a.current.updateMatrix(),a.current.updateMatrixWorld(),_e.copy(a.current.matrixWorld).invert(),b=Math.min(d,t!==void 0?t:d,p.length),a.current.count=b,a.current.instanceMatrix.updateRange.count=b*16,a.current.instanceColor.updateRange.count=b*3;for(let S=0;S<p.length;S++){const M=p[S].current;M.matrixWorld.decompose(Pe,Ie,Ae),Ce.compose(Pe,Ie,Ae).premultiply(_e),Ce.toArray(f,S*16),a.current.instanceMatrix.needsUpdate=!0,M.color.toArray(o,S*3),a.current.instanceColor.needsUpdate=!0}m++}});const j=c.useMemo(()=>({getParent:()=>a,subscribe:S=>(h(M=>[...M,S]),()=>h(M=>M.filter(P=>P.current!==S.current)))}),[]);return c.createElement("instancedMesh",le({userData:{instances:p},matrixAutoUpdate:!1,ref:$e([i,a]),args:[null,null,0],raycast:()=>null},r),c.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:f.length/16,array:f,itemSize:16,usage:Se}),c.createElement("instancedBufferAttribute",{attach:"instanceColor",count:o.length/3,array:o,itemSize:3,usage:Se}),typeof e=="function"?c.createElement(n.Provider,{value:j},e(l)):c.createElement(Le.Provider,{value:j},e))}),ds=(e,t,d,s,r)=>{const i=new rt,n=1e-5;i.absarc(n,n,n,-Math.PI/2,-Math.PI,!0),i.absarc(n,t-s*2,n,Math.PI,Math.PI/2,!0),i.absarc(e-s*2,t-s*2,n,Math.PI/2,0,!0),i.absarc(e-s*2,n,n,0,-Math.PI/2,!0);const l=new it(i,{depth:d-s*2,bevelEnabled:!0,bevelSegments:r,steps:2,bevelSize:s,bevelThickness:s,curveSegments:r});l.center();const a=[],p=l.getAttribute("normal"),h=l.getAttribute("position");for(let f=0;f<h.count;f+=1){const o=new w(p.getX(f),p.getY(f),p.getZ(f)),m=new w(h.getX(f),h.getY(f),h.getZ(f));let b=0,j=0;Math.abs(o.y)>.9?(b=m.x/e+.5,j=1-(m.z/d+.5)):Math.abs(o.x)>.9?(b=-m.z/d+.5,j=1-(-m.y/t+.5)):Math.abs(o.z)>.9&&(b=m.x/e+.5,j=1-(-m.y/t+.5)),a.push(b,j)}return l.setAttribute("uv",new at(a,2)),l};ds(10,10,10,2,10);const ue=new ot(10,10,10),He=e=>e.node_type==="topic"&&(e.scale||1)>5,ps=500,fs=800;let W=null;const ms=500,ge=(e,t)=>{if(W)return null;W=setTimeout(()=>{W&&(clearTimeout(W),W=null)},ms);const d=[];return e.forEach(r=>{const i=t.position.distanceTo(ct.set(r.x,r.y,r.z));i<fs&&d.push({id:r.ref_id||"",distance:i})}),d.sort((r,i)=>r.distance-i.distance).slice(0,ps).map(r=>r.id)},z=new w(5e3,600,1600),Ee=100,hs=600,gs=2e3,ie={x:172.7392402058252,y:-239.04675366094037,z:-2e3};let U,V;const xs=4e3,ys=2e3,bs=e=>{const t=A(),d=g(x=>x.cameraFocusTrigger),s=R(x=>x.isUserDragging),r=R(x=>x.isUserScrolling),i=R(x=>x.setUserMovedCamera),n=g(x=>x.setNearbyNodeIds),l=g(x=>x.showSelectionGraph),a=g(x=>x.data),p=g(x=>x.graphStyle),{camera:h}=pe(),[f,o]=c.useState(!1),[m,b]=c.useState(!1),[j,S]=c.useState(Ee),M=c.useMemo(()=>{if(l)return new w(0,0,0);const x=a==null?void 0:a.nodes.find(G=>G.ref_id===(t==null?void 0:t.ref_id));let C=new w(2e3,2e3,3e3);if(x&&a){const G=a==null?void 0:a.nodes.filter($=>{var be;return(be=x.children)==null?void 0:be.find(et=>et===$.id)}),L=new w(x.x,x.y,x.z);let ne=new w(0,0,0);G.map($=>(ne=ne.add(new w($.x,$.y,$.z).normalize()),$));const Je=x.scale?1-1/(x.scale+10):1,De=L.sub(ne).multiplyScalar(.8*Je);C=L.add(De)}return C},[l,t,a]),P=c.useMemo(()=>{if(l)return new w(0,0,0);const x=a==null?void 0:a.nodes.find(C=>C.ref_id===(t==null?void 0:t.ref_id));return new w((x==null?void 0:x.x)||0,(x==null?void 0:x.y)||0,(x==null?void 0:x.z)||0)},[l,t,a]);c.useEffect(()=>{var x;l&&((x=e.current)==null||x.setLookAt(ie.x,ie.y,ie.z,0,0,0,!1)),y()},[l]),c.useEffect(()=>{l?S(gs):(t==null?void 0:t.node_type)==="topic"?S(hs):S(Ee)},[t,S,l]),c.useEffect(()=>{v()},[d]),c.useEffect(()=>{(s||r)&&(o(!0),b(!0))},[s,r,o,b]),c.useEffect(()=>{if(t)if(!l&&p==="earth"&&(e!=null&&e.current)){const x=e.current.camera.position.distanceTo(new w),C=lt(P,-x/2);e.current.setLookAt(C.x,C.y,C.z,0,0,0,!0)}else U&&clearTimeout(U),U=setTimeout(()=>{b(!0),clearTimeout(U)},ys),y();return()=>{U&&clearTimeout(U),V&&clearTimeout(V)}},[t]),E(x=>{e.current&&(f||_(M,x.camera),m||N(P,x.camera))});const y=()=>{if(t){const x=h.position.distanceTo(M);Tt(x)}v()},v=()=>{o(!1),b(!1),i(!1),V&&clearTimeout(V),V=setTimeout(()=>{o(!0),b(!0)},xs)},_=(x,C)=>{if(C.position.distanceTo(x)<j)o(!0);else{C.position.lerp(x,.5);const L=ge((a==null?void 0:a.nodes)||[],h);L&&n(L)}},N=(x,C)=>{var G;(G=e==null?void 0:e.current)==null||G.setLookAt(C.position.x,C.position.y,C.position.z,x.x,x.y,x.z,!0)};return null},Ss=1;let T=null;const ws=(e,{enabled:t})=>{const d=A();bs(e);const s=R(h=>h.isUserDragging),r=g(h=>h.disableCameraRotation),i=g(h=>h.data),n=g(h=>h.graphStyle),l=g(h=>h.graphRadius),a=g(h=>h.setNearbyNodeIds);c.useEffect(()=>{t||(T==null||T.kill(),T=null)},[t]);const p=c.useCallback(()=>{T==null||T.kill();const h={value:-244},f=zt.to(h,{duration:5,keyframes:{"0%":{value:10},"100%":{delay:2,ease:"Power4.easeIn",value:-200}},onComplete:()=>{T=null},onInterrupt(){f.kill()},onUpdate:()=>{var m;const{value:o}=h;if(e.current){const b=ge((i==null?void 0:i.nodes)||[],e.current.camera);b&&a(b),(m=e.current)==null||m.dolly(o,!1)}}});f.play(),T=f},[]);return c.useEffect(()=>{e.current&&l&&(n==="sphere"?(e.current.maxDistance=8e3,e.current.minDistance=200,e.current.setTarget(0,0,500,!0)):(e.current.maxDistance=e.current.getDistanceToFitSphere(l+200),e.current.minDistance=100))},[l,n,e]),c.useEffect(()=>{p()},[p,n]),c.useEffect(()=>{!d&&e.current&&e.current.setLookAt(z.x,z.y,z.z,0,0,0,!0)},[d]),E((h,f)=>{e.current&&(!r&&!s&&(e.current.azimuthAngle+=Ss*f*ut.DEG2RAD),e.current.update(f))}),null},Ms=({disableAnimations:e})=>{const t=c.useRef(null),d=g(o=>o.graphStyle),s=g(o=>o.data),r=g(o=>o.setNearbyNodeIds),i=g(o=>o.setDisableCameraRotation),[n]=c.useState(.8),{camera:l}=pe(),[a,p,h,f]=R(o=>[o.isUserDragging,o.setIsUserDragging,o.isUserScrolling,o.isUserScrollingOnHtmlPanel]);return ws(t,{enabled:!e&&!h&&!a}),c.useEffect(()=>{t.current&&t.current.setLookAt(z.x,z.y,z.z,0,0,0,!0)},[d]),c.useEffect(()=>{if(!a){const o=ge((s==null?void 0:s.nodes)||[],l);o&&r(o)}},[l,l.position,l.position.x,l.position.y,l.position.z,s==null?void 0:s.nodes,r,a]),c.useEffect(()=>{a&&i(!0)},[a,i]),u.jsx(kt,{ref:t,boundaryEnclosesCamera:!0,enabled:!f,makeDefault:!0,maxDistance:12e3,minDistance:100,onEnd:()=>p(!1),onStart:()=>p(!0),smoothTime:n})},se={metalness:.9,roughness:0},vs={...se},js=new K(vs),_s=({hide:e})=>{const t=Fe(),d=g(r=>r.graphStyle),s=c.useMemo(()=>t.nodes.map((r,i)=>{if(r.node_type==="topic")return!1;const n=!He(r),l=me(r.node_type||"",!0);return u.jsx(Be,{color:l,name:r.id,position:[r.x,r.y,r.z],scale:n?(r.scale||1)*.9:0,userData:r},`${r.ref_id||r.id}-instanced-node-${i}-${d}`)}),[d,t]);return u.jsx(us,{geometry:ue,material:js,visible:!e,children:s})},We=new te,ee=We.load("noimage.jpeg"),Te=new K({...se,map:ee}),Ve=.4,Cs=new K({...se,map:ee,transparent:!0,opacity:Ve}),X={},Ps=(e,t)=>{const[d,s]=c.useState(ee),[r,i]=c.useState(Te);return c.useEffect(()=>{const n=`${e}${t&&"-transparent"}`;if(X[n]){s(X[n].texture),i(X[n].material);return}We.load(e,l=>{const a=new K({map:l,transparent:t,opacity:t?Ve:1,...se});X[n]={texture:l,material:a},s(l),i(a)},void 0,()=>{s(ee),i(t?Cs:Te)})},[e,t]),c.useEffect(()=>function(){d.dispose(),r.dispose()},[d,r]),r},xe=c.memo(({node:e,hide:t,animated:d})=>{const s=c.useRef(null),[r]=c.useState(ue),i=A(),n=g(h=>h.showSelectionGraph),l=!!i&&e.ref_id===i.ref_id,a=Ps(e.image_url||"noimage.jpeg",!1);E((h,f)=>{d&&s.current&&(s.current.position.set(e.x,e.y,e.z),l&&(s.current.rotation.y+=f*1,s.current.rotation.x-=f*.6))}),c.useEffect(()=>function(){r.dispose()},[r]);const p=c.useMemo(()=>n&&l?20:l?(e.scale||1)*1.2:e.scale,[e,l,n]);return u.jsx(Rt,{enabled:!!l,children:u.jsx("mesh",{ref:s,geometry:ue,material:a,name:e.id,position:[e.x,e.y,e.z],scale:p,userData:e,visible:!t})})});xe.displayName="Cube";const Is=k(de)`
  text-align: center;
  width: ${e=>e.type==="topic"?"auto":`${e.size}px`};
  height: ${e=>e.type==="topic"?"auto":`${e.size}px`};
  outline: 1px solid ${e=>I.white||e.color};
  outline-offset: 0px;
  background: rgba(0, 0, 0, 0.75);
  color: ${e=>e.fontColor};
  border-radius: ${e=>`${e.type==="guest"?"100%":"6px"}`};
  font-size: ${e=>`${e.fontSize}px`};
  cursor: pointer;
  transition: font-size 0.4s, outline 0.4s;
  transform: scale(${e=>e.scale});
  align-items: center;
  justify-content: center;
  font-family: Barlow;
  font-size: 26px;
  font-style: normal;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);

  &:hover {
    outline-offset: 4px;
  }

  &.selected {
    .badge-wrapper {
      top: 0;
    }

    font-size: 36px;

    &:hover {
      outline-offset: 0px;
    }
  }

  &.topic {
    outline: none;
    background: none;
    &:hover {
      font-size: 36px;
    }
    white-space: nowrap;
    .badge-wrapper {
      display: none;
    }
  }

  .badge-wrapper {
    position: absolute;
    top: -7px;
    left: -14px;
  }
`;k.img`
  background-image: ${({src:e})=>`url(${e})`};
  background-size: contain;
  background-repeat: no-repeat;
  width: ${e=>e.size}px;
  height: ${e=>e.size}px;
  border-radius: ${e=>e.borderRadius};
`;k.div`
  display: flex;
  position: absolute;
  bottom: -14px;
  left: -5px;
  width: auto;
  justify-content: center;
  align-items: center;
`;k.div`
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${I.transparentBlack};
  border: 2px solid ${e=>e.color};
  color: #fff;
  padding: 0 4px;
  min-width: 30px;
  height: 26px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 6px;
  margin-right: 5px;
`;k.div`
  display: flex;
  justify-content: center;
  align-items: center;
  border: 2px solid ${e=>e.color}44;
  background: ${I.transparentBlack};
  padding: 0 4px;
  color: ${e=>e.color};
  min-width: 30px;
  height: 26px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 6px;
  margin-right: 5px;
`;const As=new w,Es=({position:e,userData:t,color:d})=>{const s=c.useRef(null),[r,i]=g(m=>[m.selectedNode,m.setSelectedNode]),n=g(m=>m.setHoveredNode),l=g(m=>m.hoveredNode),a=g(m=>m.showSelectionGraph),p=((t==null?void 0:t.node_type)||"")==="topic",h=((t==null?void 0:t.node_type)||"")==="guest"||((t==null?void 0:t.node_type)||"")==="person";E(()=>{if(a&&s.current){const m=As.set((t==null?void 0:t.x)||0,(t==null?void 0:t.y)||0,(t==null?void 0:t.z)||0);s.current.position.copy(m)}}),c.useEffect(()=>function(){s.current&&s.current.clear()},[s]);const f=c.useMemo(()=>(l==null?void 0:l.ref_id)===(t==null?void 0:t.ref_id),[l==null?void 0:l.ref_id,t==null?void 0:t.ref_id]),o=(r==null?void 0:r.ref_id)===(t==null?void 0:t.ref_id);return p||o&&a||!o?u.jsx("group",{ref:s,position:e,children:u.jsx(he,{center:!0,sprite:!0,zIndexRange:[0,0],children:u.jsxs(Is,{className:pt(t==null?void 0:t.node_type,{selected:o}),color:d,fontColor:I.white,fontSize:p?64:20,onClick:m=>{m.stopPropagation(),t&&i(t)},onPointerOut:m=>{m.stopPropagation(),n(null)},onPointerOver:m=>{m.stopPropagation(),n(t||null)},scale:f?1.05:1,selected:!1,size:o?100:68,type:(t==null?void 0:t.node_type)||"",children:[!h&&!p?u.jsx("div",{className:"badge-wrapper",children:u.jsx(Dt,{type:(t==null?void 0:t.node_type)||""})}):null,p?t==null?void 0:t.label:u.jsx(Kt,{rounded:h,size:o?60:52,src:(t==null?void 0:t.image_url)||"audio_default.svg",type:t==null?void 0:t.node_type})]})})}):null},qe=c.memo(()=>{const e=g(n=>n.data),t=A(),d=g(n=>n.showSelectionGraph),s=g(n=>n.selectionGraphData),r=g(n=>n.selectedNodeRelativeIds),i=c.useMemo(()=>(d?s.nodes:(e==null?void 0:e.nodes)||[]).filter(p=>r.includes((p==null?void 0:p.ref_id)||"")||(t==null?void 0:t.ref_id)===(p==null?void 0:p.ref_id)).slice(0,Ne).map(p=>{const h=me(p.node_type||"",!0),f=new w((p==null?void 0:p.x)||0,(p==null?void 0:p.y)||0,(p==null?void 0:p.z)||0),o=((e==null?void 0:e.nodes)||[]).filter(m=>m.ref_id&&dt(m,p)).map(m=>(m==null?void 0:m.ref_id)||"")||[];return u.jsx(Es,{color:h,position:f,relativeIds:o,userData:p},`node-badge-${p.ref_id}`)}),[r,e==null?void 0:e.nodes,d,s,t]);return u.jsx(c.Fragment,{children:i.length?i:null},"node-badges")});qe.displayName="RelevanceBadges";const Ye=({link:e,animated:t})=>{const d=c.useRef(null),s=A(),[r,i]=c.useState(new w(0,0,0)),[n,l]=c.useState(new w(0,0,0)),[a,p]=c.useState(8947848),h=g(f=>f.selectionGraphData);return c.useEffect(()=>{var m,b,j,S,M,P;const f=(s==null?void 0:s.ref_id)||"",o=s&&(f===e.targetRef||f===e.sourceRef);!e.onlyVisibleOnSelect||o?(i(new w(((m=e.sourcePosition)==null?void 0:m.x)||0,((b=e.sourcePosition)==null?void 0:b.y)||0,((j=e.sourcePosition)==null?void 0:j.z)||0)),l(new w(((S=e.targetPosition)==null?void 0:S.x)||0,((M=e.targetPosition)==null?void 0:M.y)||0,((P=e.targetPosition)==null?void 0:P.z)||0))):(i(new w(0,0,0)),l(new w(0,0,0))),p(o?e.color||Ge.children.segmentColor:s?5592405:8947848)},[s,e]),E(()=>{if(t&&d.current){const f=h.nodes.find(m=>m.ref_id===e.sourceRef),o=h.nodes.find(m=>m.ref_id===e.targetRef);d.current.start.set((f==null?void 0:f.x)||0,(f==null?void 0:f.y)||0,(f==null?void 0:f.z)||0),d.current.end.set((o==null?void 0:o.x)||0,(o==null?void 0:o.y)||0,(o==null?void 0:o.z)||0)}}),u.jsx(Nt,{ref:d,color:"0xFFFFFF",end:n,start:r})},ye=c.memo(({node:e,hide:t})=>{const d=c.useRef(null),s=A(),i=g(h=>h.selectedNodeRelativeIds).includes((e==null?void 0:e.ref_id)||""),n=!!s&&(s==null?void 0:s.id)===e.id,l=g(h=>h.showSelectionGraph);E(({camera:h})=>{d!=null&&d.current&&(d.current.quaternion.copy(h.quaternion),l&&d.current.position.set(e.x,e.y,e.z))});const a=c.useMemo(()=>{let h=(e.scale||1)*4;return l&&n?h=40:!n&&i&&(h=0),h},[e.scale,n,i,l]),p=c.useMemo(()=>s&&s.node_type==="topic"&&!n?.2:1,[n,s]);return u.jsx(Ct,{ref:d,anchorX:"center",anchorY:"middle",color:I.white,fillOpacity:p,position:[e.x,e.y,e.z],scale:a,userData:e,visible:!t&&!n,...Xt,children:e.label})});ye.displayName="TextNode";let ae=null;const Ke=c.memo(()=>{const e=Fe(),t=A(),d=g(i=>i.selectedNodeRelativeIds),s=g(i=>i.selectionGraphData),r=g(i=>i.setSelectionData);return c.useEffect(()=>{const i=e.nodes.filter(l=>l.ref_id===(t==null?void 0:t.ref_id)||d.includes((l==null?void 0:l.ref_id)||"")).map(l=>{const a=l.ref_id===(t==null?void 0:t.ref_id)&&l.node_type!=="topic"?{fx:0,fy:0,fz:0}:{};return{...l,x:0,y:0,z:0,...a}}),n=ft(i,!1,!1);r({nodes:i,links:n})},[e,t,d,r]),c.useEffect(()=>{ae=mt(s.nodes,s.links,{numDimensions:2,forceLinkStrength:.01,forceCenterStrength:.85,forceChargeStrength:-20,velocityDecay:.9})},[s]),E(()=>{ae&&ae.tick()}),u.jsxs(u.Fragment,{children:[s==null?void 0:s.nodes.map(i=>i.node_type==="topic"?u.jsx(ye,{hide:!0,node:i},`${i.ref_id||i.id}-compact`):u.jsx(xe,{animated:!0,hide:!0,node:i},`${i.ref_id||i.id}-compact`)),u.jsx(Ue,{fog:!0,lineWidth:.9,children:(s==null?void 0:s.links).map((i,n)=>u.jsx(Ye,{animated:!0,link:i},n.toString()))},`selection-links-${s==null?void 0:s.links.length}`)]})});Ke.displayName="SelectionDataNodes";const Ze=c.memo(()=>{const e=ht(),t=A(),d=g(o=>o.nearbyNodeIds),s=g(o=>o.setHoveredNode),r=g(o=>o.showSelectionGraph),i=g(o=>o.selectionGraphData),n=Oe(o=>o.setTranscriptOpen),l=c.useCallback(o=>!!(r&&!i.nodes.find(m=>m.ref_id===o.ref_id)),[r,i]),a=c.useCallback(o=>{const m=o==null?void 0:o[0];m&&(n(!1),m.userData&&(l(m.userData)||g.getState().setSelectedNode((m==null?void 0:m.userData)||null)))},[n,l]),p=c.useCallback(o=>{o.stopPropagation(),s(null)},[s]),h=c.useCallback(o=>{var j;const b=o.intersections.map(S=>S.object)[0];if((j=b==null?void 0:b.userData)!=null&&j.ref_id){const S=b.userData;l(S)||(o.stopPropagation(),s(S))}},[s,l]),f=r&&!!t;return u.jsxs(Gt,{filter:o=>o.filter(m=>{var b;return!!((b=m.userData)!=null&&b.id)}),onChange:a,onPointerOut:p,onPointerOver:h,children:[u.jsx(_s,{hide:f}),u.jsx(qe,{}),e==null?void 0:e.nodes.filter(o=>{const m=(o==null?void 0:o.ref_id)===(t==null?void 0:t.ref_id);return d.includes(o.ref_id||"")||He(o)||m}).map(o=>o.node_type==="topic"?u.jsx(ye,{hide:f,node:o},o.ref_id||o.id):u.jsx(xe,{hide:f,node:o},o.ref_id||o.id)),f&&u.jsx(Ke,{})]})});Ze.displayName="Cubes";const Ts={earthRef:null},zs=gt(e=>({...Ts,setEarthRef:t=>e({earthRef:t})})),ks=(e,t)=>{const d=new D().setFromUnitVectors(new w(0,1,0),e.clone().normalize()),s=new D().setFromUnitVectors(new w(0,1,0),t.clone().normalize()),r=new D,i=50,n=[];for(let a=0;a<=i;a+=1){const p=a/i;r.slerpQuaternions(d,s,p);const h=new w(0,1,0).applyQuaternion(r).multiplyScalar(q+xt);n.push(h)}return new yt(n).getPoints(i)},Rs=({link:e})=>{const t=A(),[d,s]=c.useState(8947848);c.useEffect(()=>{const i=(t==null?void 0:t.ref_id)||"",n=t&&(i===e.targetRef||i===e.sourceRef);s(n?e.color||Ge.children.segmentColor:t?5592405:8947848)},[t,e]);const r=c.useMemo(()=>{var p,h,f,o,m,b;const i=(t==null?void 0:t.ref_id)||"",n=t&&(i===e.targetRef||i===e.sourceRef);if(!(!e.onlyVisibleOnSelect||n))return[];const l=new w(((p=e.sourcePosition)==null?void 0:p.x)||0,((h=e.sourcePosition)==null?void 0:h.y)||0,((f=e.sourcePosition)==null?void 0:f.z)||0),a=new w(((o=e.targetPosition)==null?void 0:o.x)||0,((m=e.targetPosition)==null?void 0:m.y)||0,((b=e.targetPosition)==null?void 0:b.z)||0);return ks(l,a)},[e,t]);return r.length?u.jsx(Pt,{color:d,dashed:!1,lineWidth:3,points:r}):null},Ns=new w(0,0,0),Gs=()=>{const e=c.useRef(null),t=c.useRef(null),d=g(a=>a.graphStyle),s=g(a=>a.showSelectionGraph),r=g(a=>a.data),i=zs(a=>a.setEarthRef),n=O("textures/earth/galaxy.png"),l=O("textures/earth/clouds.png");return E(({camera:a})=>{t.current&&t.current.position.copy(a.getWorldPosition(Ns))}),c.useLayoutEffect(()=>{e.current&&i(e)},[i]),d!=="earth"||s?null:u.jsxs(u.Fragment,{children:[u.jsxs("mesh",{ref:e,userData:{type:"earth"},children:[u.jsx("sphereGeometry",{args:[q,200,200]}),u.jsx(Os,{})]}),u.jsxs("mesh",{children:[u.jsx("sphereGeometry",{args:[q+2,200,200]}),u.jsx("meshStandardMaterial",{alphaMap:l,map:l,transparent:!0})]}),u.jsxs("mesh",{children:[u.jsx("sphereGeometry",{args:[q*4,200,200]}),u.jsx("meshStandardMaterial",{map:n,opacity:.4,side:bt,transparent:!0})]}),u.jsx("directionalLight",{ref:t,intensity:.9,position:[0,0,q*3]}),r==null?void 0:r.links.map((a,p)=>u.jsx(Rs,{link:a},`curved-${p}`))]})},Os=()=>{const e=O("textures/earth/earth.jpeg"),t=O("textures/earth/bump.jpeg"),d=O("textures/earth/water.png"),s=c.useMemo(()=>new K({map:e,bumpMap:t,aoMap:t,roughnessMap:t,metalnessMap:d,toneMapped:!0,roughness:35,metalness:0}),[e,t,d]);return u.jsx("meshStandardMaterial",{...s})},F=2e3,Q=At*4,ze=Object.values(It).map(e=>e),$s=()=>{const e=c.useRef(null);E(()=>{var n,l,a,p,h;const r=(l=(n=e.current)==null?void 0:n.geometry.getAttribute("position"))==null?void 0:l.array,i=(p=(a=e.current)==null?void 0:a.geometry.getAttribute("velocity"))==null?void 0:p.array;if(r&&i){for(let f=0;f<r.length;f+=3){const o=r[f],m=r[f+1],b=r[f+2],j=i[f],S=i[f+1],M=i[f+2];r[f]+=j,r[f+1]+=S,r[f+2]+=M;const P=Math.sqrt(o*o+m*m+b*b);if(P*P>Q*Q){const v=Math.random()*Math.PI*2,_=Math.random()*Math.PI*2,N=Math.random()*Q;r[f]=Math.sin(v)*Math.cos(_)*N,r[f+1]=Math.sin(v)*Math.sin(_)*N,r[f+2]=Math.cos(v)*N}}((h=e.current)==null?void 0:h.geometry.getAttribute("position")).needsUpdate=!0}});const t=c.useMemo(()=>new Float32Array(F*3),[]),d=c.useMemo(()=>new Float32Array(F*3),[]);c.useEffect(()=>{const r=Q;for(let i=0;i<F;i+=1){const n=i*3,l=Math.acos(1-i/F*2),a=Math.PI*2*i/F;t[n]=Math.sin(l)*Math.cos(a)*r,t[n+1]=Math.sin(l)*Math.sin(a)*r,t[n+2]=Math.cos(l)*r,d[n]=Math.random()-.5,d[n+1]=Math.random()-.5,d[n+2]=Math.random()-.5}},[t,d]);const s=c.useRef(null);return c.useEffect(()=>{s.current&&e.current&&(s.current.setAttribute("position",new oe(t,3)),s.current.setAttribute("velocity",new oe(d,3)),e.current.geometry=s.current)},[t,d]),c.useEffect(()=>{if(s.current){const r=[];for(let i=0;i<F;i+=1){const n=Math.floor(Math.random()*ze.length),l=ze[n],a=new Re(l);a.multiplyScalar(2),r.push(a.r,a.g,a.b)}s.current.setAttribute("color",new oe(new Float32Array(r),3))}},[]),u.jsxs("points",{ref:e,frustumCulled:!1,children:[u.jsx("bufferGeometry",{ref:s}),u.jsx("pointsMaterial",{opacity:.8,size:4,transparent:!0,vertexColors:!0})]})},J=e=>({close:{backgroundColor:"rgba(48, 51, 66, 1)",borderColor:"#fff",fontColor:"rgba(255, 255, 255, 1)"},focus:{backgroundColor:e?"rgba(255, 255, 255, 0.90);":"rgba(255, 255, 255, 0.90)",borderColor:e?"#FFDB58bb":"#fff",fontColor:"rgba(48, 51, 66, 1)"},menu:{backgroundColor:"#00000066",borderColor:e?"#ffffff66":"#5078f2",fontColor:e?"#ffffff66":"#fff"}}),Us=new w,Xe=c.memo(()=>{const e=c.useRef(null),t=Oe(y=>y.setSidebarOpen),[d,s]=St.useState(null),{open:r}=re("editNodeName"),{open:i}=re("addEdgeToNode"),{open:n}=re("mergeToNode"),[l]=wt(y=>[y.isAdmin]),a=g(y=>y.showSelectionGraph),p=g(y=>y.selectionGraphData),h=g(y=>y.data),f=A(),o=g(y=>y.setSelectedNode),m=g(y=>y.setShowSelectionGraph);E(()=>{b()});const b=c.useCallback(()=>{const y=a?p:h;if(e.current){const v=y==null?void 0:y.nodes.find(_=>_.ref_id===(f==null?void 0:f.ref_id));if(v){const _=Us.set(v==null?void 0:v.x,v==null?void 0:v.y,v==null?void 0:v.z);e.current.position.copy(_)}}},[f,a,p,h]),j=c.useMemo(()=>{const y=l?[{key:"control-key-1",colors:J(a).focus,icon:u.jsx(is,{}),left:-80,className:"add",onClick:_=>{s(_.currentTarget)}},{key:"control-key-2",colors:J(a).focus,icon:u.jsx(Ot,{}),left:-40,className:"edit",onClick:()=>{r()}}]:[],v=[{key:"control-key-4",colors:J(a).focus,icon:u.jsx(es,{}),left:0,className:"expand",onClick:()=>{const _=!a;m(_),_&&t(!0)}},{key:"control-key-5",colors:J(!0).close,icon:u.jsx(ts,{}),left:40,className:"exit",onClick:()=>{o(null),m(!1)}}];return[...y,...v].map((_,N)=>({..._,left:-80+N*40}))},[a,r,m,t,o,l]);if(!f)return null;const S=()=>{s(null)},M=!!d,P=M?"simple-popover":void 0;return u.jsx("group",{ref:e,children:u.jsxs(he,{center:!0,className:"control-panel",onClick:y=>y.stopPropagation(),onKeyDown:y=>y.stopPropagation(),onPointerDown:y=>y.stopPropagation(),onPointerOut:y=>y.stopPropagation(),onPointerOver:y=>y.stopPropagation(),onPointerUp:y=>y.stopPropagation(),sprite:!0,zIndexRange:[16777271,16777272],children:[j.map(y=>u.jsx(Fs,{backgroundColor:y.colors.backgroundColor,borderColor:y.colors.borderColor,className:y.className,fontColor:y.colors.fontColor,left:y.left,onClick:v=>{v.stopPropagation(),y.onClick(v)},children:y.icon},y.key)),u.jsxs(Ls,{anchorEl:d,anchorOrigin:{vertical:"bottom",horizontal:"right"},id:P,onClose:S,open:M,transformOrigin:{vertical:"top",horizontal:"right"},children:[u.jsxs(ke,{"data-testid":"merge",onClick:()=>{n(),S()},children:[u.jsx(ss,{"data-testid":"MergeIcon"})," Merge"]}),u.jsxs(ke,{"data-testid":"add_edge",onClick:()=>{i(),S()},children:[u.jsx(ns,{"data-testid":"AddCircleIcon"})," Add edge"]})]})]})})});Xe.displayName="NodeControls";const Fs=k.div`
  position: fixed;
  top: -60px;
  left: ${e=>-7+e.left}px;
  width: 24px;
  height: 24px;

  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${e=>e.backgroundColor?e.backgroundColor:"#000000bb"};
  color: ${e=>e.fontColor?e.fontColor:"#ffffff"};
  border-radius: 100%;
  font-size: 16px;
  cursor: pointer;
  transition: opacity 0.4s;
  box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
`,ke=k(de).attrs({direction:"row",px:12,py:8})`
  display: flex;
  align-items: center;
  justify-content: start;
  gap: 12px;
  cursor: pointer;
  background: ${I.BUTTON1};
  color: ${I.white};

  &:hover {
    background: ${I.BUTTON1_HOVER};
    color: ${I.GRAY3};
  }
`,Ls=k(as)`
  && {
    z-index: 9999;
  }
  .MuiPaper-root {
    min-width: 149px;
    color: ${I.GRAY3};
    box-shadow: 0px 1px 6px 0px rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    z-index: 1;
    font-family: Barlow;
    font-size: 14px;
    font-weight: 500;
  }
`,Qe=c.memo(()=>u.jsx(u.Fragment,{children:u.jsx(Xe,{})}));Qe.displayName="NodeDetailsPanel";const Bs=()=>{const e=g(p=>p.data),t=g(p=>p.isFetching),d=g(p=>p.graphStyle),s=g(p=>p.showSelectionGraph),r=g(p=>p.selectedNodeRelativeIds),i=g(p=>p.selectionGraphData),n=g(p=>p.selectedNode),l=c.useMemo(()=>s?0:d==="force"?.2:.4,[s,d]),a=c.useMemo(()=>(s?i.nodes:(e==null?void 0:e.nodes)||[]).filter(o=>r.includes((o==null?void 0:o.ref_id)||"")||(n==null?void 0:n.ref_id)===(o==null?void 0:o.ref_id)).slice(0,Ne).map(o=>{const m=new w(n==null?void 0:n.x,n==null?void 0:n.y,n==null?void 0:n.z),b=new w(o.x,o.y,o.z),j={source:n!=null&&n.id?n.id:"",target:o.id?o.id:"",targetRef:o.ref_id,sourceRef:n==null?void 0:n.ref_id,sourcePosition:m,targetPosition:b};return u.jsx(Ye,{link:j},o.id)}),[r,e==null?void 0:e.nodes,s,i,n]);return t?null:u.jsxs(u.Fragment,{children:[u.jsx(Ze,{}),u.jsx(Gs,{}),u.jsx($s,{}),d!=="earth"&&u.jsx(Ue,{fog:!0,limit:a.length,lineWidth:l,children:a},`links-${a.length}-${d}`),u.jsx(Qe,{})]})},Hs=()=>u.jsx(he,{children:u.jsx(Lt,{})}),Ws=()=>{const{universeColor:e}=Zt("universe",{universeColor:I.black}),t=A(),d=c.useMemo(()=>t!=null&&t.node_type?me(t.node_type):jt,[t]);return u.jsxs(u.Fragment,{children:[u.jsx("color",{args:[e],attach:"background"}),u.jsx(Jt,{}),u.jsx(Ms,{}),u.jsxs(Bt,{children:[u.jsxs(Ht,{autoClear:!1,multisampling:8,children:[u.jsx(Wt,{darkness:.7,eskil:!1,offset:.05}),u.jsx(Vt,{luminanceThreshold:1,mipmapBlur:!0,resolutionX:we.AUTO_SIZE,resolutionY:we.AUTO_SIZE}),u.jsx(qt,{blendFunction:Yt.SCREEN,blur:!0,edgeStrength:4,hiddenEdgeColor:d,visibleEdgeColor:d})]}),u.jsx(Bs,{})]})]})};let ce=null;const Vs={aspect:window.innerWidth/window.innerHeight,far:3e4,near:1,position:[z.x,z.y,z.z]},qs=()=>{const[e,t,d]=[R(n=>n.setIsUserScrollingOnHtmlPanel),R(n=>n.setIsUserScrolling),R(n=>n.setUserMovedCamera)],s=g(n=>n.isFetching),r=c.useCallback(n=>{var p;const{target:l}=n,{offsetParent:a}=l;ce&&clearTimeout(ce),(p=a==null?void 0:a.classList)!=null&&p.contains("html-panel")&&a.clientHeight<a.scrollHeight&&e(!0),t(!0),d(!0),ce=setTimeout(()=>{t(!1),e(!1)},200)},[t,e,d]),i=c.useCallback(n=>Mt(n,"threeState"),[]);return u.jsxs(Ys,{children:[u.jsx(c.Suspense,{fallback:null,children:u.jsxs(Et,{camera:Vs,id:"universe-canvas",onCreated:i,onWheel:r,children:[vt&&u.jsx(Qt,{position:"top-right"}),u.jsxs(c.Suspense,{fallback:u.jsx(Hs,{}),children:[u.jsx($t,{}),u.jsx(Ut,{}),u.jsx(Ft,{}),u.jsx(Ws,{})]})]})}),s&&u.jsx(os,{fullSize:!1}),u.jsx(rs,{})]})},Ys=k(de)`
  flex: 1 1 100%;
  position: relative;
`,gn=c.memo(qs);export{gn as Universe};
