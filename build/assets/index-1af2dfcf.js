import{r as o,_ as V,aj as Te,ak as De,V as b,ai as U,am as ge,bl as Me,bm as Re,ax as Ae,ay as Le,az as Ge,aA as Ue,aC as Oe,au as Fe,j as d,aE as Be,f as W,h as T,F as X,b4 as he,bn as $e,bo as He,bp as Ve,bq as We,br as qe,bs as Y,x as Ye,af as Xe,i as me,b6 as Ze,b7 as Ke,b8 as Qe,k as Je,l as et,aP as tt,a3 as nt}from"./index-b648bda2.js";import{e as ot,m as re,b as k,u as xe,H as Z,L as st,C as rt,g as it,h as at}from"./Selection-9c06badb.js";import{u as R,p as ct,g as lt,C as ut,S as dt,T as ye,a as be,b as ft,E as pt,P as gt,A as ht,c as mt,L as xt,d as yt,V as bt,B as St,R as ae,O as wt,e as Pt}from"./EditIcon-000ea430.js";import{j as Se,C as Ct}from"./react-toastify.esm-97ee9838.js";import{u as A,a as S,f as vt}from"./index-128c4fe4.js";import{D as we,P as _t}from"./PlusIcon-9dabb621.js";import{c as jt}from"./index.esm-cd549611.js";import{u as Q}from"./index-508aaedf.js";import"./index-9c751dc8.js";const ce=new ge,J=new Me,le=new Re,ee=new b;class Nt extends Te{constructor(){super(),this.size=0,this.color=new De("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var t;return(t=this.instance.current)==null?void 0:t.geometry}raycast(t,i){var s,a;const r=this.instance.current;if(!r||!r.geometry)return;const l=r.userData.instances.indexOf(this.instanceKey);if(l===-1||l>r.geometry.drawRange.count)return;const n=(s=(a=t.params.Points)==null?void 0:a.threshold)!==null&&s!==void 0?s:1;if(le.set(this.getWorldPosition(ee),n),t.ray.intersectsSphere(le)===!1)return;ce.copy(r.matrixWorld).invert(),J.copy(t.ray).applyMatrix4(ce);const c=n/((this.scale.x+this.scale.y+this.scale.z)/3),h=c*c,p=J.distanceSqToPoint(ee);if(p<h){const u=new b;J.closestPointToPoint(ee,u),u.applyMatrix4(this.matrixWorld);const g=t.ray.origin.distanceTo(u);if(g<t.near||g>t.far)return;i.push({distance:g,distanceToRay:Math.sqrt(p),point:u,index:l,face:null,object:this})}}}let L,F;const Pe=o.createContext(null),ue=new ge,de=new b,kt=o.forwardRef(({children:e,range:t,limit:i=1e3,...s},a)=>{const r=o.useRef(null),[l,n]=o.useState([]),[[c,h,p]]=o.useState(()=>[new Float32Array(i*3),Float32Array.from({length:i*3},()=>1),Float32Array.from({length:i},()=>1)]);o.useEffect(()=>{r.current.geometry.attributes.position.needsUpdate=!0}),k(()=>{for(r.current.updateMatrix(),r.current.updateMatrixWorld(),ue.copy(r.current.matrixWorld).invert(),r.current.geometry.drawRange.count=Math.min(i,t!==void 0?t:i,l.length),L=0;L<l.length;L++)F=l[L].current,F.getWorldPosition(de).applyMatrix4(ue),de.toArray(c,L*3),r.current.geometry.attributes.position.needsUpdate=!0,F.matrixWorldNeedsUpdate=!0,F.color.toArray(h,L*3),r.current.geometry.attributes.color.needsUpdate=!0,p.set([F.size],L),r.current.geometry.attributes.size.needsUpdate=!0});const u=o.useMemo(()=>({getParent:()=>r,subscribe:g=>(n(y=>[...y,g]),()=>n(y=>y.filter(P=>P.current!==g.current)))}),[]);return o.createElement("points",V({userData:{instances:l},matrixAutoUpdate:!1,ref:re([a,r]),raycast:()=>null},s),o.createElement("bufferGeometry",null,o.createElement("bufferAttribute",{attach:"attributes-position",count:c.length/3,array:c,itemSize:3,usage:U}),o.createElement("bufferAttribute",{attach:"attributes-color",count:h.length/3,array:h,itemSize:3,usage:U}),o.createElement("bufferAttribute",{attach:"attributes-size",count:p.length,array:p,itemSize:1,usage:U})),o.createElement(Pe.Provider,{value:u},e))}),Et=o.forwardRef(({children:e,...t},i)=>{o.useMemo(()=>ot({PositionPoint:Nt}),[]);const s=o.useRef(),{subscribe:a,getParent:r}=o.useContext(Pe);return o.useLayoutEffect(()=>a(s),[]),o.createElement("positionPoint",V({instance:r(),instanceKey:s,ref:re([i,s])},t),e)}),zt=o.forwardRef(({children:e,positions:t,colors:i,sizes:s,stride:a=3,...r},l)=>{const n=o.useRef(null);return k(()=>{const c=n.current.geometry.attributes;c.position.needsUpdate=!0,i&&(c.color.needsUpdate=!0),s&&(c.size.needsUpdate=!0)}),o.createElement("points",V({ref:re([l,n])},r),o.createElement("bufferGeometry",null,o.createElement("bufferAttribute",{attach:"attributes-position",count:t.length/a,array:t,itemSize:a,usage:U}),i&&o.createElement("bufferAttribute",{attach:"attributes-color",count:i.length/a,array:i,itemSize:3,usage:U}),s&&o.createElement("bufferAttribute",{attach:"attributes-size",count:s.length/a,array:s,itemSize:1,usage:U})),e)}),It=o.forwardRef((e,t)=>e.positions instanceof Float32Array?o.createElement(zt,V({},e,{ref:t})):o.createElement(kt,V({},e,{ref:t}))),Tt=(e,t,i,s,a)=>{const r=new Le,l=1e-5;r.absarc(l,l,l,-Math.PI/2,-Math.PI,!0),r.absarc(l,t-s*2,l,Math.PI,Math.PI/2,!0),r.absarc(e-s*2,t-s*2,l,Math.PI/2,0,!0),r.absarc(e-s*2,l,l,0,-Math.PI/2,!0);const n=new Ge(r,{depth:i-s*2,bevelEnabled:!0,bevelSegments:a,steps:2,bevelSize:s,bevelThickness:s,curveSegments:a});n.center();const c=[],h=n.getAttribute("normal"),p=n.getAttribute("position");for(let u=0;u<p.count;u+=1){const g=new b(h.getX(u),h.getY(u),h.getZ(u)),y=new b(p.getX(u),p.getY(u),p.getZ(u));let P=0,v=0;Math.abs(g.y)>.9?(P=y.x/e+.5,v=1-(y.z/i+.5)):Math.abs(g.x)>.9?(P=-y.z/i+.5,v=1-(-y.y/t+.5)):Math.abs(g.z)>.9&&(P=y.x/e+.5,v=1-(-y.y/t+.5)),c.push(P,v)}return n.setAttribute("uv",new Ue(c,2)),n};Tt(10,10,10,2,10);new Ae(10,10,10);const Dt=500,Mt=800,Rt=new b(0,0,0),At=16777215;let B=null;const Lt=500,ie=(e,t)=>{if(B)return null;B=setTimeout(()=>{B&&(clearTimeout(B),B=null)},Lt);const i=[];return e.forEach(a=>{const r=t.position.distanceTo(Rt.set(a.x,a.y,a.z));r<Mt&&i.push({id:a.ref_id||"",distance:r})}),i.sort((a,r)=>a.distance-r.distance).slice(0,Dt).map(a=>a.id)},M=new b(0,0,0),fe=100,Gt=600,Ut=2e3,te={x:172.7392402058252,y:-239.04675366094037,z:-2e3};let G,$;const Ot=4e3,Ft=2e3,Bt=e=>{const t=A(),i=S(m=>m.cameraFocusTrigger),s=R(m=>m.isUserDragging),a=R(m=>m.isUserScrolling),r=R(m=>m.setUserMovedCamera),l=S(m=>m.setNearbyNodeIds),n=S(m=>m.showSelectionGraph),c=S(m=>m.data),h=S(m=>m.graphStyle),{camera:p}=xe(),[u,g]=o.useState(!1),[y,P]=o.useState(!1),[v,E]=o.useState(fe),f=o.useMemo(()=>{if(n)return new b(0,0,0);const m=c==null?void 0:c.nodes.find(I=>I.ref_id===(t==null?void 0:t.ref_id));let _=new b(2e3,2e3,3e3);if(m&&c){const I=[],O=new b(m.x,m.y,m.z);let K=new b(0,0,0);I.map(q=>(K=K.add(new b(q.x,q.y,q.z).normalize()),q));const ze=m.edge_count?1-1/(m.edge_count+10):1,Ie=O.sub(K).multiplyScalar(.8*ze);_=O.add(Ie)}return _},[n,t,c]),C=o.useMemo(()=>{if(n)return new b(0,0,0);const m=c==null?void 0:c.nodes.find(_=>_.ref_id===(t==null?void 0:t.ref_id));return new b((m==null?void 0:m.x)||0,(m==null?void 0:m.y)||0,(m==null?void 0:m.z)||0)},[n,t,c]);o.useEffect(()=>{var m;n&&((m=e.current)==null||m.setLookAt(te.x,te.y,te.z,0,0,0,!1)),j()},[n]),o.useEffect(()=>{n?E(Ut):(t==null?void 0:t.node_type)==="topic"?E(Gt):E(fe)},[t,E,n]),o.useEffect(()=>{x()},[i]),o.useEffect(()=>{(s||a)&&(g(!0),P(!0))},[s,a,g,P]),o.useEffect(()=>{if(t)if(!n&&h==="earth"&&(e!=null&&e.current)){const m=e.current.camera.position.distanceTo(new b),_=Oe(C,-m/2);e.current.setLookAt(_.x,_.y,_.z,0,0,0,!0)}else G&&clearTimeout(G),G=setTimeout(()=>{P(!0),clearTimeout(G)},Ft),j();return()=>{G&&clearTimeout(G),$&&clearTimeout($)}},[t]),k(m=>{e.current&&(u||w(f,m.camera),y||z(C,m.camera))});const j=()=>{if(t){const m=p.position.distanceTo(f);ct(m)}x()},x=()=>{g(!1),P(!1),r(!1),$&&clearTimeout($),$=setTimeout(()=>{g(!0),P(!0)},Ot)},w=(m,_)=>{if(_.position.distanceTo(m)<v)g(!0);else{_.position.lerp(m,.5);const O=ie((c==null?void 0:c.nodes)||[],p);O&&l(O)}},z=(m,_)=>{var I;(I=e==null?void 0:e.current)==null||I.setLookAt(_.position.x,_.position.y,_.position.z,m.x,m.y,m.z,!0)};return null},$t=1;let D=null;const Ht=(e,{enabled:t})=>{const i=A();Bt(e);const s=R(p=>p.isUserDragging),a=S(p=>p.disableCameraRotation),r=S(p=>p.data),l=S(p=>p.graphStyle),n=S(p=>p.graphRadius),c=S(p=>p.setNearbyNodeIds);o.useEffect(()=>{t||(D==null||D.kill(),D=null)},[t]);const h=o.useCallback(()=>{D==null||D.kill();const p={value:-244},u=lt.to(p,{duration:5,keyframes:{"0%":{value:10},"100%":{delay:2,ease:"Power4.easeIn",value:-200}},onComplete:()=>{D=null},onInterrupt(){u.kill()},onUpdate:()=>{var y;const{value:g}=p;if(e.current){const P=ie((r==null?void 0:r.nodes)||[],e.current.camera);P&&c(P),(y=e.current)==null||y.dolly(g,!1)}}});u.play(),D=u},[]);return o.useEffect(()=>{e.current&&n&&(l==="sphere"?(e.current.maxDistance=8e3,e.current.minDistance=200,e.current.setTarget(0,0,500,!0)):(e.current.maxDistance=e.current.getDistanceToFitSphere(n+200),e.current.minDistance=100))},[n,l,e]),o.useEffect(()=>{h()},[h,l]),o.useEffect(()=>{!i&&e.current&&e.current.setLookAt(M.x,M.y,M.z,0,0,0,!0)},[i]),k((p,u)=>{e.current&&(!a&&!s&&(e.current.azimuthAngle+=$t*u*Fe.DEG2RAD),e.current.update(u))}),null},Vt=({disableAnimations:e})=>{const t=o.useRef(null),i=S(g=>g.graphStyle),s=S(g=>g.data),a=S(g=>g.setNearbyNodeIds),r=S(g=>g.setDisableCameraRotation),[l]=o.useState(.8),{camera:n}=xe(),[c,h,p,u]=R(g=>[g.isUserDragging,g.setIsUserDragging,g.isUserScrolling,g.isUserScrollingOnHtmlPanel]);return Ht(t,{enabled:!e&&!p&&!c}),o.useEffect(()=>{t.current&&t.current.setLookAt(M.x,M.y,M.z,0,0,0,!0)},[i]),o.useEffect(()=>{if(!c){const g=ie((s==null?void 0:s.nodes)||[],n);g&&a(g)}},[n,n.position,n.position.x,n.position.y,n.position.z,s==null?void 0:s.nodes,a,c]),o.useEffect(()=>{c&&r(!0)},[c,r]),d.jsx(ut,{ref:t,boundaryEnclosesCamera:!0,enabled:!u,makeDefault:!0,maxDistance:12e3,minDistance:100,onEnd:()=>h(!1),onStart:()=>h(!0),smoothTime:l})},Wt=["#ffffff","#ffffcc","#ccffcc","#ffccff","#ccccff","#ffd699","#c2f0c2","#ff6666","#99ccff","#ffb3b3"],qt=new b,Yt=({position:e,userData:t})=>{const i=o.useRef(null),[s,a]=S(n=>[n.selectedNode,n.nodeTypes]),r=S(n=>n.showSelectionGraph);return k(()=>{if(r&&i.current){const n=qt.set((t==null?void 0:t.x)||0,(t==null?void 0:t.y)||0,(t==null?void 0:t.z)||0);i.current.position.copy(n)}}),o.useEffect(()=>function(){i.current&&i.current.clear()},[i]),(s==null?void 0:s.ref_id)===(t==null?void 0:t.ref_id)?null:d.jsx("group",{ref:i,position:e,children:d.jsx(Z,{center:!0,sprite:!0,zIndexRange:[0,0],children:d.jsx(Xt,{bgColor:Wt[Math.max(a.indexOf(t.node_type),0)],children:t.node_type})})})},Ce=o.memo(()=>{const e=S(r=>r.data),t=S(r=>r.showSelectionGraph),i=S(r=>r.selectionGraphData),s=S(r=>r.selectedNodeRelativeIds),a=o.useMemo(()=>(t?i.nodes:(e==null?void 0:e.nodes)||[]).filter(c=>s.includes((c==null?void 0:c.ref_id)||"")).slice(0,Be).map(c=>{const h=new b((c==null?void 0:c.x)||0,(c==null?void 0:c.y)||0,(c==null?void 0:c.z)||0),p=[];return d.jsx(Yt,{position:h,relativeIds:p,userData:c},`node-badge-${c.ref_id}`)}),[s,e==null?void 0:e.nodes,t,i]);return d.jsx(o.Fragment,{children:a.length?a:null},"node-badges")});Ce.displayName="RelevanceBadges";const Xt=W.div`
  position: absolute;
  left: 50%;
  top: 20%;
  transform: translateX(-50%) translateY(200%);
  padding: 0 4px;
  height: 14px;
  background: ${e=>e.bgColor};
  color: ${T.BG1};
  font-size: 8px;
  font-style: normal;
  font-weight: 800;
  line-height: 14px;
`,Zt=({position:e,title:t,onRemove:i})=>{const s=o.useRef(null);return o.useEffect(()=>function(){s.current&&s.current.clear()},[s]),d.jsx("group",{ref:s,position:e,children:d.jsx(Z,{center:!0,sprite:!0,children:d.jsxs(Kt,{direction:"row",justify:"center",onClick:a=>{a.stopPropagation()},onPointerOut:a=>{a.stopPropagation()},onPointerOver:a=>{a.stopPropagation()},children:[d.jsx("span",{children:t}),d.jsx(X,{className:"icon",onClick:i,children:d.jsx(we,{})})]})})})},Kt=W(X)`
  text-align: center;

  outline-offset: 0px;
  background: rgba(0, 0, 0, 0.75);
  color: #eee;
  cursor: pointer;
  transition: font-size 0.4s, outline 0.4s;
  align-items: center;
  justify-content: center;
  font-family: Barlow;
  font-size: 16px;
  font-style: normal;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);

  &:hover {
    outline-offset: 4px;
    span {
      opacity: 0.1;
    }

    .icon {
      display: flex;
    }
  }

  .icon {
    position: absolute;
    width: 24px;
    height: 24px;
    /* bottom: 100%; */
    display: none;
    color: #000;
    border-radius: 40px;
    justify-content: center;
    align-items: center;
    background: #ffffff;
    color: #000;
    border-radius: 100%;
    font-size: 16px;
    cursor: pointer;
    transition: opacity 0.4s;
    box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
  }

  .badge-wrapper {
    position: absolute;
    top: -7px;
    left: -14px;
  }
`,Qt=(e,t)=>{const i=e.reduce((a,r,l)=>{if(l<e.length-1){const n=e[l+1],c=new b().subVectors(n,r).length();return a+c}return a},0);let s=0;for(let a=0;a<e.length-1;a+=1){const r=e[a],l=e[a+1],n=new b().subVectors(l,r).length();if(t<=(s+n)/i){const c=(t*i-s)/n;return new b().lerpVectors(r,l,c)}s+=n}return e[e.length-1]},Jt=({link:e,title:t,onRemove:i})=>{const s=o.useRef(null),a=o.useRef(null),r=A(),[l,n]=o.useState(new b(0,0,0)),[c,h]=o.useState(new b(0,0,0)),[p,u]=o.useState("#ff13c9"),[g]=S(x=>[x.selectionGraphData]),[y,P]=o.useState(0);k(()=>{P(x=>(x+.01)%1)}),o.useEffect(()=>{var x,w,z,m,_,I;n(new b(((x=e.sourcePosition)==null?void 0:x.x)||0,((w=e.sourcePosition)==null?void 0:w.y)||0,((z=e.sourcePosition)==null?void 0:z.z)||0)),h(new b(((m=e.targetPosition)==null?void 0:m.x)||0,((_=e.targetPosition)==null?void 0:_.y)||0,((I=e.targetPosition)==null?void 0:I.z)||0)),u("#ff13c9")},[r,e]);const v=new b().addVectors(l,c).multiplyScalar(.5);k(()=>{if(s.current){const x=g.nodes.find(z=>z.ref_id===e.source),w=g.nodes.find(z=>z.ref_id===e.target);s.current.start.set((x==null?void 0:x.x)||0,(x==null?void 0:x.y)||0,(x==null?void 0:x.z)||0),s.current.end.set((w==null?void 0:w.x)||0,(w==null?void 0:w.y)||0,(w==null?void 0:w.z)||0),n(new b((x==null?void 0:x.x)||0,(x==null?void 0:x.y)||0,(x==null?void 0:x.z)||0)),h(new b((w==null?void 0:w.x)||0,(w==null?void 0:w.y)||0,(w==null?void 0:w.z)||0))}});const E=new b(0,0,0),f=![e.target,e.source].includes((r==null?void 0:r.ref_id)||""),C=new he(l,E,c),j=f?C.getPoints(2):[l,c];return d.jsxs(d.Fragment,{children:[d.jsx(dt,{ref:s,color:"transparent",end:c,start:l}),d.jsxs(It,{limit:1,range:1,children:[d.jsx("pointsMaterial",{vertexColors:!0}),d.jsx(Et,{ref:a,color:p,position:Qt(j,y),size:20})]}),d.jsx(Zt,{onRemove:i,position:v,title:t})]})},en={font:"/fonts/Inter-Bold.woff",characters:"abcdefghijklmnopqrstuvwxyz0123456789!",fontSize:8,letterSpacing:-.05,lineHeight:1,"material-toneMapped":!1},ve=o.memo(({node:e})=>{const t=o.useRef(null),i=A(),a=S(h=>h.selectedNodeRelativeIds).includes((e==null?void 0:e.ref_id)||""),r=!!i&&(i==null?void 0:i.ref_id)===e.ref_id,l=S(h=>h.showSelectionGraph);k(({camera:h})=>{t!=null&&t.current&&(t.current.quaternion.copy(h.quaternion),l&&t.current.position.set(e.x,e.y,e.z))});const n=o.useMemo(()=>((e.edge_count||1)*4,(e.edge_count||1)*4),[e.edge_count,r,a,l]),c=o.useMemo(()=>1,[r,i,a]);return d.jsx(ye,{ref:t,anchorX:"center",anchorY:"middle",color:T.white,fillOpacity:c,position:[e.x,e.y,e.z],scale:Math.min(n,10),userData:e,visible:!0,...en,children:e.name})});ve.displayName="SelectionNode";const pe=$e().stop(),N={numDimensions:3,velocityDecay:.9,forceChargeStrength:-20,forceChargeMinDistance:150,forceChargeMaxDistance:8e3,forceLinkStrength:.04,forceCenterStrength:.85,disableCollide:!1,disableCenter:!1,disableLink:!1,disableCharge:!1,forceCollideRadiusMethod:e=>((e.edge_count||1)+20)*6+200,forceLinkDistanceMethod:()=>150},tn=(e,t,{numDimensions:i=N.numDimensions,velocityDecay:s=N.velocityDecay,forceChargeStrength:a=N.forceChargeStrength,forceChargeMinDistance:r=N.forceChargeMinDistance,forceChargeMaxDistance:l=N.forceChargeMaxDistance,forceLinkStrength:n=N.forceLinkStrength,forceCenterStrength:c=N.forceCenterStrength,forceLinkDistanceMethod:h=N.forceLinkDistanceMethod,forceCollideRadiusMethod:p=N.forceCollideRadiusMethod,disableCollide:u=N.disableCollide,disableCenter:g=N.disableCenter,disableLink:y=N.disableLink,disableCharge:P=N.disableCharge})=>(pe.alpha(1).stop().numDimensions(i).velocityDecay(s).force("collide",u?null:He().radius(p).iterations(1)).force("center",g?null:Ve().strength(c)).force("charge",P?null:We().strength(a).distanceMin(r).distanceMax(l)).nodes(e).force("link",y?null:qe().distance(h).strength(n).id(v=>v.ref_id)).alpha(1).restart(),pe);let ne=null;const _e=o.memo(()=>{const e=A(),[t,i,s]=S(n=>[n.data,n.selectedNodeRelativeIds,n.removeLink]),[a,r]=S(n=>[n.selectionGraphData,n.setSelectionData]);o.useEffect(()=>{if(a.nodes.length>0)return;const n=((t==null?void 0:t.nodes)||[]).filter(p=>i.includes(p.ref_id)||p.ref_id===(e==null?void 0:e.ref_id)).map(p=>{const u=p.ref_id===(e==null?void 0:e.ref_id)?{fx:0,fy:0,fz:0}:{};return{...p,x:0,y:0,z:0,...u}}),c=(t==null?void 0:t.links.filter(p=>n.some(u=>u.ref_id===p.target)&&n.some(u=>u.ref_id===p.source)))||[];r({nodes:n,links:c})},[t,e,i,a.nodes.length,r]),o.useEffect(()=>{ne=tn([...a.nodes],[...a.links],{numDimensions:2,forceLinkStrength:.1,forceCenterStrength:.1,forceChargeStrength:20,velocityDecay:.9})},[a]),k(()=>{ne&&ne.tick()});const l=n=>{const c=n.target===(e==null?void 0:e.ref_id)?n.source:n.target,h=a.nodes.filter(u=>u.ref_id!==c),p=a.links.filter(u=>u.ref_id!==n.ref_id);r({nodes:h,links:p}),s(n.ref_id,c)};return d.jsxs(d.Fragment,{children:[d.jsx(be,{fog:!0,lineWidth:.9,children:a.links.map(n=>d.jsx(Jt,{link:n,onRemove:()=>l(n),title:n.edge_type},n.ref_id))},`selection-links-${a==null?void 0:a.links.length}`),a.nodes.map(n=>d.jsx(ve,{node:n},`${n.ref_id}-compact`))]})});_e.displayName="SelectionDataNodes";const nn={font:"/fonts/Inter-Bold.woff",characters:"abcdefghijklmnopqrstuvwxyz0123456789!",fontSize:2,letterSpacing:-.05,lineHeight:1,"material-toneMapped":!1},je=o.memo(({node:e,hide:t})=>{const i=o.useRef(null),s=A(),[a,r]=S(y=>[y.selectedNodeRelativeIds,y.nodeTypes]),l=a.includes((e==null?void 0:e.ref_id)||""),n=!!s&&(s==null?void 0:s.ref_id)===e.ref_id,c=S(y=>y.showSelectionGraph);k(({camera:y})=>{i!=null&&i.current&&(i.current.quaternion.copy(y.quaternion),c&&i.current.position.set(e.x,e.y,e.z))});const h=o.useMemo(()=>((e.edge_count||1)*4,(e.edge_count||1)*4),[e.edge_count,n,l,c]),p=o.useMemo(()=>s&&!n&&!l?.1:1,[n,s,l]),u=Y[r.indexOf(e.node_type)]||Y[0],g=s?(s==null?void 0:s.ref_id)===e.ref_id:!0;return d.jsx(ye,{ref:i,anchorX:"center",anchorY:"middle",color:u,fillOpacity:p,position:[e.x,e.y,e.z],scale:Math.min(h,10),userData:e,visible:!t&&g,...nn,children:e.name})});je.displayName="TextNode";const Ne=o.memo(()=>{const[e,t,i,s,a,r]=S(u=>[u.data,u.selectedNode,u.setHoveredNode,u.showSelectionGraph,u.selectionGraphData,u.setSelectedNode]),l=o.useCallback(u=>!!(s&&!a.nodes.find(g=>g.ref_id===u.ref_id)),[s,a]),n=o.useCallback(u=>{const g=u==null?void 0:u[0];g&&g.userData&&(l(g.userData)||r((g==null?void 0:g.userData)||null))},[l,r]),c=o.useCallback(u=>{u.stopPropagation(),i(null)},[i]),h=o.useCallback(u=>{var P;const y=u.intersections.map(v=>v.object)[0];if((P=y==null?void 0:y.userData)!=null&&P.ref_id){const v=y.userData;l(v)||(u.stopPropagation(),i(v))}},[i,l]),p=s&&!!t;return d.jsxs(ft,{filter:u=>u.filter(g=>{var y;return!!((y=g.userData)!=null&&y.ref_id)}),onChange:n,onPointerOut:c,onPointerOver:h,children:[s&&d.jsx(Ce,{}),e==null?void 0:e.nodes.map(u=>d.jsx(je,{hide:p,node:u},u.ref_id)),p&&d.jsx(_e,{},t.ref_id)]})});Ne.displayName="Cubes";const on=({link:e,animated:t})=>{var v,E;const i=A(),[s,a]=o.useState(new b(0,0,0)),[r,l]=o.useState(new b(0,0,0)),[n]=o.useState(Y[0]),c=S(f=>f.nodesNormalized);o.useEffect(()=>{var f,C,j,x,w,z;a(new b(((f=e.sourcePosition)==null?void 0:f.x)||0,((C=e.sourcePosition)==null?void 0:C.y)||0,((j=e.sourcePosition)==null?void 0:j.z)||0)),l(new b(((x=e.targetPosition)==null?void 0:x.x)||0,((w=e.targetPosition)==null?void 0:w.y)||0,((z=e.targetPosition)==null?void 0:z.z)||0))},[i,e]);const h=new b(0,1,0),p=new he(s,h,r),u=((v=c[e.source])==null?void 0:v.node_type)!==((E=c[e.target])==null?void 0:E.node_type),g=u?Y[1]:n,y=u?p.getPoints(50):[s,r],P=!i||i.ref_id===e.source||i.ref_id===e.target;return d.jsx(st,{color:g,opacity:.1,points:y.map(f=>f.toArray()),transparent:!0,visible:P})},H=e=>({close:{backgroundColor:"rgba(48, 51, 66, 1)",borderColor:"#fff",fontColor:"rgba(255, 255, 255, 1)"},focus:{backgroundColor:e?"rgba(255, 255, 255, 0.90);":"rgba(255, 255, 255, 0.90)",borderColor:e?"#FFDB58bb":"#fff",fontColor:"rgba(48, 51, 66, 1)"},menu:{backgroundColor:"#00000066",borderColor:e?"#ffffff66":"#5078f2",fontColor:e?"#ffffff66":"#fff"}}),sn=new b,ke=o.memo(()=>{const e=o.useRef(null),{open:t}=Q("editNodeName"),{open:i}=Q("removeNode"),{open:s}=Q("addEdgeToNode"),[a]=Ye(f=>[f.isAdmin]),r=S(f=>f.showSelectionGraph),[l,n,c,h]=S(f=>[f.selectionGraphData,f.setSelectionData,f.selectedNodeRelativeIds,f.setSelectedNodeRelativeIds]),[p]=S(f=>[f.data,f.setData]),u=A(),g=S(f=>f.setSelectedNode),y=S(f=>f.setShowSelectionGraph);k(()=>{v()});const P=o.useCallback(async()=>{try{if(u!=null&&u.ref_id){const f=await vt(u==null?void 0:u.ref_id,l.nodes.length||0),C=((f==null?void 0:f.edges)||[]).filter(x=>!l.links.some(w=>x.target===w.target&&x.source===w.source)),j=((f==null?void 0:f.nodes)||[]).filter(x=>!l.nodes.some(w=>x.ref_id===w.ref_id));n({links:[...l.links,...C.map(x=>({...x,sourcePosition:new b,targetPosition:new b}))],nodes:[...l.nodes,...j.map(x=>({...x,x:0,y:0,z:0}))]}),h([...new Set([...c,...j.map(x=>x.ref_id)])])}}catch(f){console.log(f)}},[u==null?void 0:u.ref_id,c,l.links,l.nodes,h,n]),v=o.useCallback(()=>{const f=r?l:p;if(e.current){const C=f==null?void 0:f.nodes.find(j=>j.ref_id===(u==null?void 0:u.ref_id));if(C){const j=sn.set(C==null?void 0:C.x,C==null?void 0:C.y,C==null?void 0:C.z);e.current.position.copy(j)}}},[u,r,l,p]),E=o.useMemo(()=>{const f=[{key:"control-key-1",colors:H(r).focus,icon:d.jsx(_t,{}),left:-80,className:"add",onClick:()=>{s()}},{key:"control-key-2",colors:H(r).focus,icon:d.jsx(pt,{}),left:-40,className:"edit",onClick:()=>{t()}},{key:"control-key-3",colors:H(r).focus,icon:d.jsx(we,{}),left:0,className:"delete",onClick:()=>{i()}}],C=[{key:"control-key-5",colors:H(!0).close,icon:d.jsx(Xe,{}),left:40,className:"exit",onClick:()=>{P()}},{key:"control-key-6",colors:H(!0).close,icon:d.jsx(jt,{}),left:40,className:"exit",onClick:()=>{g(null),y(!1)}}];return[...f,...C].map((j,x)=>({...j,left:-80+x*40}))},[a,r,s,t,i,y,g,P]);return u?d.jsx("group",{ref:e,children:d.jsx(Z,{center:!0,className:"control-panel",onClick:f=>f.stopPropagation(),onKeyDown:f=>f.stopPropagation(),onPointerDown:f=>f.stopPropagation(),onPointerOut:f=>f.stopPropagation(),onPointerOver:f=>f.stopPropagation(),onPointerUp:f=>f.stopPropagation(),sprite:!0,zIndexRange:[16777271,16777272],children:E.map(f=>d.jsx(rn,{backgroundColor:f.colors.backgroundColor,borderColor:f.colors.borderColor,className:f.className,fontColor:f.colors.fontColor,left:f.left,onClick:C=>{C.stopPropagation(),f.onClick()},children:f.icon},f.key))})}):null});ke.displayName="NodeControls";const rn=W.div`
  position: fixed;
  top: -60px;
  left: ${e=>-7+e.left}px;
  width: 24px;
  height: 24px;

  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${e=>e.backgroundColor?e.backgroundColor:"#000000bb"};
  color: ${e=>e.fontColor?e.fontColor:"#ffffff"};
  border-radius: 100%;
  font-size: 16px;
  cursor: pointer;
  transition: opacity 0.4s;
  box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
`,Ee=o.memo(()=>d.jsx(d.Fragment,{children:d.jsx(ke,{})}));Ee.displayName="NodeDetailsPanel";const an=()=>{const[e,t,i,s,a]=S(n=>[n.data,n.isFetching,n.graphStyle,n.showSelectionGraph,n.selectionGraphData]),r=o.useMemo(()=>s?0:i==="force"?.2:.4,[s,i]),l=o.useMemo(()=>((s?a.links:e==null?void 0:e.links)||[]).map(h=>d.jsx(on,{link:h},h.ref_id)),[e==null?void 0:e.links,a.links,s]);return t?null:d.jsxs(d.Fragment,{children:[d.jsx(Ne,{}),!1,!s&&d.jsx(be,{fog:!0,limit:l.length,lineWidth:r,children:l}),d.jsx(Ee,{}),!1]})},oe=5e3,cn=()=>{const{fogColor:e}=Se("universe",{fogColor:Qe}),t=me(r=>r.graphStyle),i=o.useRef(null),s=o.useRef(null),a=o.useRef(null);return k(({camera:r,clock:l})=>{const n=l.getElapsedTime();if(i.current){const h=Math.sin(n/8)*1e3;i.current.position.setZ(h)}if(s.current&&s.current.position.lerp(r.position,.5),a.current){const c=n*.5,h=Math.sin(c)*oe,p=Math.cos(c)*oe;a.current.position.set(h,0,p)}}),d.jsxs(d.Fragment,{children:[d.jsx("hemisphereLight",{args:[T.white,Ze,Ke]}),t!=="earth"&&d.jsx("fog",{args:[e,5,18e3],attach:"fog"}),d.jsx("ambientLight",{color:T.white,intensity:1}),d.jsx("pointLight",{ref:s,color:T.white,distance:4e3,intensity:5,position:[0,0,0]}),d.jsx("directionalLight",{ref:a,color:T.white,intensity:8,position:[oe,0,0]}),d.jsx("pointLight",{ref:i,color:T.white,distance:4e3,intensity:8,position:[0,0,0]})]})},ln=({fullSize:e=!0})=>{const t=Je(i=>i.sidebarIsOpen);return d.jsx(un,{align:"center",className:et({"sidebar-is-open":t&&!e}),justify:"center",children:d.jsx(Ct,{color:T.SECONDARY_BLUE,size:64})})},un=W(X)`
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  top: 0;
  background-color: ${T.black};
  z-index: 1;
`,dn=()=>d.jsx(Z,{children:d.jsx(xt,{})}),fn=()=>{const{universeColor:e}=Se("universe",{universeColor:T.black}),t=nt(),i=o.useMemo(()=>t!=null&&t.node_type?it(t.node_type):At,[t]);return d.jsxs(d.Fragment,{children:[d.jsx("color",{args:[e],attach:"background"}),d.jsx(cn,{}),d.jsx(Vt,{}),d.jsxs(at,{children:[d.jsxs(yt,{autoClear:!1,multisampling:8,children:[d.jsx(bt,{darkness:.7,eskil:!1,offset:.05}),d.jsx(St,{luminanceThreshold:1,mipmapBlur:!0,resolutionX:ae.AUTO_SIZE,resolutionY:ae.AUTO_SIZE}),d.jsx(wt,{blendFunction:Pt.SCREEN,blur:!0,edgeStrength:4,hiddenEdgeColor:i,visibleEdgeColor:i})]}),d.jsx(an,{})]})]})};let se=null;const pn={aspect:window.innerWidth/window.innerHeight,far:3e4,near:1,position:[M.x,M.y,M.z]},gn=()=>{const[e,t,i]=[R(l=>l.setIsUserScrollingOnHtmlPanel),R(l=>l.setIsUserScrolling),R(l=>l.setUserMovedCamera)],s=me(l=>l.isFetching),a=o.useCallback(l=>{var h;const{target:n}=l,{offsetParent:c}=n;se&&clearTimeout(se),(h=c==null?void 0:c.classList)!=null&&h.contains("html-panel")&&c.clientHeight<c.scrollHeight&&e(!0),t(!0),i(!0),se=setTimeout(()=>{t(!1),e(!1)},200)},[t,e,i]),r=o.useCallback(l=>tt(l,"threeState"),[]);return d.jsxs(hn,{children:[d.jsx(o.Suspense,{fallback:null,children:d.jsx(rt,{camera:pn,id:"universe-canvas",onCreated:r,onWheel:a,children:d.jsxs(o.Suspense,{fallback:d.jsx(dn,{}),children:[d.jsx(gt,{}),d.jsx(ht,{}),d.jsx(mt,{}),d.jsx(fn,{})]})})}),s&&d.jsx(ln,{fullSize:!1})]})},hn=W(X)`
  flex: 1 1 100%;
  position: relative;
`,_n=o.memo(gn);export{_n as Universe};
